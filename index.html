<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>RPG Stage Clicker</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        /* –£–ë–ò–†–ê–ï–ú –°–ò–ù–Æ–Æ –û–ë–í–û–î–ö–£ –ò –í–´–î–ï–õ–ï–ù–ò–ï */
        * {
            -webkit-tap-highlight-color: transparent;
            outline: none;
            user-select: none;
            -webkit-user-select: none;
        }

        :root {
            --bg-color: #121212;
            --card-bg: #1e1e1e;
            --accent: #ff9800;
            --hp-color: #e74c3c;
            --xp-color: #3498db;
            --text-primary: #ffffff;
            --text-secondary: #b0b0b0;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-primary);
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        #saveStatus {
            position: absolute;
            top: 75px;
            right: 15px;
            font-size: 11px;
            color: #2ecc71;
            opacity: 0;
            transition: opacity 0.5s;
            z-index: 20;
            font-weight: bold;
            text-shadow: 0 1px 2px black;
        }

        /* --- –í–ï–†–•–ù–Ø–Ø –ü–ê–ù–ï–õ–¨ --- */
        .hero-panel {
            padding: 15px;
            background: rgba(30, 30, 30, 0.95);
            border-bottom: 1px solid #333;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 10;
            position: relative;
        }

        .hero-info { display: flex; flex-direction: column; }
        .hero-lvl { color: var(--accent); font-size: 14px; font-weight: bold; }
        .hero-dps { font-size: 10px; color: #888; margin-top: 2px; }
        .gold-display { font-size: 18px; color: #f1c40f; font-weight: bold; }

        .xp-container {
            height: 6px;
            width: 100%;
            background: #111;
            position: absolute;
            bottom: 0;
            left: 0;
        }
        .xp-bar {
            height: 100%;
            background: var(--xp-color);
            width: 0%;
            transition: width 0.3s;
            box-shadow: 0 0 10px var(--xp-color);
        }

        /* --- –ê–†–ï–ù–ê --- */
        .arena {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            position: relative;
            background: radial-gradient(circle at center, #2c3e50 0%, #121212 70%);
        }

        /* –ù–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ —É—Ä–æ–≤–Ω—è–º */
        .stage-nav {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 10px;
            z-index: 10;
        }
        .nav-btn {
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            color: white;
            width: 40px;
            height: 30px;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .nav-btn:active { background: rgba(255,255,255,0.2); }
        .nav-btn:disabled { opacity: 0.3; cursor: default; }

        .stage-info {
            text-align: center;
        }
        .stage-title { font-size: 12px; color: #888; text-transform: uppercase; }
        .stage-number { font-size: 24px; font-weight: bold; color: var(--accent); }

        /* –ò–Ω—Ñ–æ –º–æ–Ω—Å—Ç—Ä–∞ */
        .monster-counter {
            font-size: 14px;
            color: #aaa;
            margin-bottom: 5px;
            background: rgba(0,0,0,0.4);
            padding: 2px 8px;
            border-radius: 10px;
        }

        .hp-bar-container {
            width: 240px;
            height: 24px;
            background: #333;
            border-radius: 12px;
            overflow: hidden;
            border: 2px solid #555;
            position: relative;
            margin-bottom: 20px;
            z-index: 10;
        }
        .hp-bar {
            width: 100%;
            height: 100%;
            background: var(--hp-color);
            transition: width 0.1s linear;
        }
        .hp-text {
            position: absolute;
            width: 100%;
            text-align: center;
            top: 0;
            line-height: 24px;
            font-size: 12px;
            font-weight: bold;
            color: white;
            text-shadow: 0 0 3px black;
        }

        /* –ú–æ–Ω—Å—Ç—Ä */
        .monster-sprite {
            font-size: 140px;
            cursor: pointer;
            transition: transform 0.05s;
            filter: drop-shadow(0 0 30px rgba(0,0,0,0.5));
            position: relative;
            z-index: 5;
            /* –í–∞–∂–Ω–æ –¥–ª—è –º–æ–±–∏–ª–æ–∫: —É–±–∏—Ä–∞–µ—Ç –ø–æ–¥—Å–≤–µ—Ç–∫—É */
            -webkit-tap-highlight-color: transparent;
        }
        .monster-sprite:active { transform: scale(0.92); }
        .monster-sprite.hit { animation: shake 0.15s; }
        .monster-sprite.dead { animation: die 0.4s forwards; }

        .is-boss .monster-sprite { font-size: 180px; filter: drop-shadow(0 0 60px rgba(231, 76, 60, 0.6)); }
        .is-boss .hp-bar-container { border-color: #e74c3c; box-shadow: 0 0 20px rgba(231, 76, 60, 0.4); }

        /* --- –ù–ò–ñ–ù–Ø–Ø –ü–ê–ù–ï–õ–¨ --- */
        .controls {
            background: var(--card-bg);
            border-top-left-radius: 20px;
            border-top-right-radius: 20px;
            height: 42vh;
            display: flex;
            flex-direction: column;
            box-shadow: 0 -5px 30px rgba(0,0,0,0.6);
            overflow: hidden;
        }

        .tabs {
            display: flex;
            background: rgba(0,0,0,0.2);
            flex-shrink: 0;
        }

        .tab-btn {
            flex: 1;
            padding: 15px;
            background: none;
            border: none;
            color: #777;
            font-weight: bold;
            font-size: 14px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
        }
        .tab-btn.active {
            color: white;
            border-bottom: 3px solid var(--accent);
            background: rgba(255,255,255,0.05);
        }

        .tab-content {
            padding: 15px;
            overflow-y: auto;
            flex-grow: 1;
            display: none;
            padding-bottom: 50px;
        }
        .tab-content.active { display: block; }

        .upgrade-card {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(255,255,255,0.05);
            padding: 10px;
            border-radius: 12px;
            margin-bottom: 8px;
            border: 1px solid rgba(255,255,255,0.05);
        }
        .upgrade-info h4 { margin: 0; font-size: 14px; color: white; }
        .upgrade-info p { margin: 3px 0 0; font-size: 11px; color: var(--text-secondary); }

        .buy-btn {
            background: #27ae60;
            color: white;
            border: none;
            padding: 8px 10px;
            border-radius: 8px;
            font-size: 12px;
            font-weight: bold;
            min-width: 80px;
            text-align: center;
        }
        .buy-btn:disabled { background: #444; color: #888; opacity: 0.7; }

        /* –ê–Ω–∏–º–∞—Ü–∏–∏ */
        .damage-text {
            position: absolute;
            color: white;
            font-weight: 900;
            font-size: 26px;
            pointer-events: none;
            animation: floatUp 0.6s ease-out forwards;
            text-shadow: 2px 2px 0 #000;
            z-index: 100;
        }
        .crit { color: #e74c3c; font-size: 34px; z-index: 101; }
        .reward-text { color: #f1c40f; font-size: 22px; z-index: 102; text-shadow: 0 2px 4px black; width: 100%; text-align: center; left: 0 !important; }

        @keyframes floatUp {
            0% { transform: translateY(0) scale(1); opacity: 1; }
            100% { transform: translateY(-70px) scale(1.1); opacity: 0; }
        }
        @keyframes shake {
            0% { transform: translate(0,0) rotate(0); }
            25% { transform: translate(-4px, 0) rotate(-4deg); }
            75% { transform: translate(4px, 0) rotate(4deg); }
            100% { transform: translate(0,0) rotate(0); }
        }
        @keyframes die {
            0% { transform: scale(1); opacity: 1; }
            100% { transform: scale(0); opacity: 0; }
        }
    </style>
</head>
<body>

    <div class="hero-panel">
        <div class="hero-info">
            <div class="hero-lvl" id="heroLvlText">LVL 1</div>
            <div class="hero-dps" id="heroDpsText">0 DPS</div>
        </div>
        <div class="gold-display">
            <span id="gold">0</span> üí∞
        </div>
        <div class="xp-container"><div class="xp-bar" id="xpBar"></div></div>
    </div>

    <div id="saveStatus">üíæ –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ</div>

    <div class="arena" id="arena">

        <div class="stage-nav">
            <button class="nav-btn" id="prevStageBtn" onclick="changeStage(-1)">‚óÄ</button>
            <div class="stage-info">
                <div class="stage-title">STAGE</div>
                <div class="stage-number" id="stageNum">1</div>
            </div>
            <button class="nav-btn" id="nextStageBtn" onclick="changeStage(1)">‚ñ∂</button>
        </div>

        <div class="monster-counter" id="monsterCounter">1 / 10</div>

        <div class="hp-bar-container">
            <div class="hp-bar" id="hpBar"></div>
            <div class="hp-text" id="hpText">Loading...</div>
        </div>

        <div class="monster-sprite" id="monster" onpointerdown="attack(event)">üëæ</div>
    </div>

    <div class="controls">
        <div class="tabs">
            <button class="tab-btn active" onclick="openTab('hero')">ü¶∏ –ì–µ—Ä–æ–π</button>
            <button class="tab-btn" onclick="openTab('allies')">üõ°Ô∏è –ê—Ä–º–∏—è</button>
        </div>

        <div id="tab-hero" class="tab-content active">
            <div class="upgrade-card">
                <div class="upgrade-info">
                    <h4>‚öîÔ∏è –°–∏–ª–∞ (Damage)</h4>
                    <p>–£—Ä–æ–Ω: <span id="dmgVal">1</span></p>
                </div>
                <button class="buy-btn" id="btnBuyDmg" onclick="upgrade('damage')">10 üí∞</button>
            </div>

            <div class="upgrade-card">
                <div class="upgrade-info">
                    <h4>üéØ –ú–µ—Ç–∫–æ—Å—Ç—å (Crit %)</h4>
                    <p>–®–∞–Ω—Å: <span id="critVal">0</span>%</p>
                </div>
                <button class="buy-btn" id="btnBuyCrit" onclick="upgrade('crit')">50 üí∞</button>
            </div>

            <div class="upgrade-card">
                <div class="upgrade-info">
                    <h4>üò° –Ø—Ä–æ—Å—Ç—å (Crit Dmg)</h4>
                    <p>–ú–Ω–æ–∂–∏—Ç–µ–ª—å: x<span id="critMultiVal">2.0</span></p>
                </div>
                <button class="buy-btn" id="btnBuyFerocity" onclick="upgrade('ferocity')">200 üí∞</button>
            </div>

            <div class="upgrade-card">
                <div class="upgrade-info">
                    <h4>üí∞ –ê–ª—á–Ω–æ—Å—Ç—å (Gold)</h4>
                    <p>–ë–æ–Ω—É—Å –∑–æ–ª–æ—Ç–∞: +<span id="greedVal">0</span>%</p>
                </div>
                <button class="buy-btn" id="btnBuyGreed" onclick="upgrade('greed')">500 üí∞</button>
            </div>
        </div>

        <div id="tab-allies" class="tab-content">
            <div class="upgrade-card">
                <div class="upgrade-info">
                    <h4>üèπ –õ—É—á–Ω–∏–∫</h4>
                    <p>+5 DPS | –£—Ä. <span id="allyArcherLvl">0</span></p>
                </div>
                <button class="buy-btn" id="btnBuyArcher" onclick="upgradeAlly('archer')">100 üí∞</button>
            </div>

            <div class="upgrade-card">
                <div class="upgrade-info">
                    <h4>üßô –ú–∞–≥</h4>
                    <p>+25 DPS | –£—Ä. <span id="allyMageLvl">0</span></p>
                </div>
                <button class="buy-btn" id="btnBuyMage" onclick="upgradeAlly('mage')">600 üí∞</button>
            </div>

            <div class="upgrade-card">
                <div class="upgrade-info">
                    <h4>‚öîÔ∏è –†—ã—Ü–∞—Ä—å</h4>
                    <p>+100 DPS | –£—Ä. <span id="allyKnightLvl">0</span></p>
                </div>
                <button class="buy-btn" id="btnBuyKnight" onclick="upgradeAlly('knight')">3K üí∞</button>
            </div>

            <div class="upgrade-card">
                <div class="upgrade-info">
                    <h4>üîÆ –ß–µ—Ä–Ω–æ–∫–Ω–∏–∂–Ω–∏–∫</h4>
                    <p>+500 DPS | –£—Ä. <span id="allyWarlockLvl">0</span></p>
                </div>
                <button class="buy-btn" id="btnBuyWarlock" onclick="upgradeAlly('warlock')">20K üí∞</button>
            </div>

            <div class="upgrade-card">
                <div class="upgrade-info">
                    <h4>üóø –¢–∏—Ç–∞–Ω</h4>
                    <p>+2500 DPS | –£—Ä. <span id="allyTitanLvl">0</span></p>
                </div>
                <button class="buy-btn" id="btnBuyTitan" onclick="upgradeAlly('titan')">150K üí∞</button>
            </div>

            <div class="upgrade-card">
                <div class="upgrade-info">
                    <h4>üëº –ê–Ω–≥–µ–ª</h4>
                    <p>+10K DPS | –£—Ä. <span id="allyAngelLvl">0</span></p>
                </div>
                <button class="buy-btn" id="btnBuyAngel" onclick="upgradeAlly('angel')">1M üí∞</button>
            </div>
        </div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();

        // –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø
        const initialState = {
            gold: 0,
            level: 1, // –£—Ä–æ–≤–µ–Ω—å –≥–µ—Ä–æ—è
            xp: 0,
            xpToNext: 100,

            // –ü—Ä–æ–≥—Ä–µ—Å—Å —ç—Ç–∞–ø–æ–≤
            stage: 1,       // –¢–µ–∫—É—â–∏–π —ç—Ç–∞–ø, –Ω–∞ –∫–æ—Ç–æ—Ä–æ–º —Å–∏–¥–∏—Ç –∏–≥—Ä–æ–∫
            maxStage: 1,    // –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –æ—Ç–∫—Ä—ã—Ç—ã–π —ç—Ç–∞–ø
            killsInStage: 0, // –£–±–∏—Ç–æ –º–æ–Ω—Å—Ç—Ä–æ–≤ –Ω–∞ —Ç–µ–∫—É—â–µ–º —ç—Ç–∞–ø–µ (0-9). 10-–π —ç—Ç–æ –±–æ—Å—Å.

            stats: {
                damage: 1,
                critChance: 0,
                critMulti: 2.0, // –¢–µ–ø–µ—Ä—å –∫–∞—á–∞–µ—Ç—Å—è
                goldBonus: 0    // –ü—Ä–æ—Ü–µ–Ω—Ç –±–æ–Ω—É—Å–∞
            },

            allies: {
                archer: { lvl: 0, dps: 5, cost: 100 },
                mage: { lvl: 0, dps: 25, cost: 600 },
                knight: { lvl: 0, dps: 100, cost: 3000 },
                warlock: { lvl: 0, dps: 500, cost: 20000 },
                titan: { lvl: 0, dps: 2500, cost: 150000 },
                angel: { lvl: 0, dps: 10000, cost: 1000000 }
            },

            costs: {
                damage: 10,
                crit: 50,
                ferocity: 200,
                greed: 500
            },

            monster: { hp: 20, maxHp: 20, type: 0, isBoss: false }
        };

        let game = JSON.parse(JSON.stringify(initialState));
        let isCloudLoading = true;

        const monsters = ["üëæ", "üëπ", "üíÄ", "üëª", "ü§ñ", "ü¶ñ", "üßõ", "üßü"];
        const bosses = ["üê≤", "üêô", "ü¶ç", "üëø", "üë∫", "üëΩ"];

        // === –°–û–•–†–ê–ù–ï–ù–ò–Ø ===
        function initGame() {
            tg.CloudStorage.getItem('rpg_save_v5_stages', (err, value) => {
                if (!err && value) {
                    try {
                        const parsed = JSON.parse(value);
                        game = {
                            ...game,
                            ...parsed,
                            // –°–ª–∏—è–Ω–∏–µ –≤–ª–æ–∂–µ–Ω–Ω—ã—Ö –æ–±—ä–µ–∫—Ç–æ–≤
                            stats: { ...game.stats, ...parsed.stats },
                            allies: { ...game.allies, ...parsed.allies },
                            costs: { ...game.costs, ...parsed.costs }
                        };
                    } catch (e) { console.error(e); }
                }
                isCloudLoading = false;
                renderUI();
                spawnMonster(false);
            });
        }

        function saveGame() {
            if (isCloudLoading) return;
            const dataStr = JSON.stringify(game);
            localStorage.setItem('rpg_save_v5_stages', dataStr);
            tg.CloudStorage.setItem('rpg_save_v5_stages', dataStr, (err, stored) => {
                if (!err && stored) showSaveStatus();
            });
        }

        function showSaveStatus() {
            const el = document.getElementById('saveStatus');
            el.style.opacity = 1;
            setTimeout(() => el.style.opacity = 0, 3000);
        }

        // –ê–≤—Ç–æ—Å–µ–π–≤ –∫–∞–∂–¥—ã–µ 2 –º–∏–Ω—É—Ç—ã
        setInterval(saveGame, 120000);

        // === –ò–ì–†–û–í–ê–Ø –õ–û–ì–ò–ö–ê ===

        // DPS Loop
        setInterval(() => {
            if (isCloudLoading) return;
            const dps = calculateDps();
            if (dps > 0 && game.monster.hp > 0) {
                dealDamage(dps / 10, false, false);
            }
        }, 100);

        function calculateDps() {
            let total = 0;
            for (let key in game.allies) {
                total += game.allies[key].lvl * game.allies[key].dps;
            }
            return total;
        }

        function attack(e) {
            if (isCloudLoading || game.monster.hp <= 0) return;

            let damage = game.stats.damage;
            let isCrit = Math.random() * 100 < game.stats.critChance;

            if (isCrit) damage = Math.floor(damage * game.stats.critMulti);

            isCrit ? tg.HapticFeedback.notificationOccurred('warning') : tg.HapticFeedback.impactOccurred('light');

            // –ü–æ–ª—É—á–∞–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –¥–ª—è —ç—Ñ—Ñ–µ–∫—Ç–∞
            let x = e.clientX || (window.innerWidth / 2);
            let y = e.clientY || (window.innerHeight / 2);

            dealDamage(damage, true, isCrit, x, y);
        }

        function dealDamage(amount, isClick, isCrit, x, y) {
            game.monster.hp -= amount;

            if (isClick) {
                showFloatingText(x, y, Math.floor(amount), isCrit ? 'crit' : 'damage');
                animateMonsterHit();
            }

            if (game.monster.hp <= 0) {
                game.monster.hp = 0;
                killMonster();
            }
            renderUI();
        }

        function killMonster() {
            tg.HapticFeedback.notificationOccurred('success');

            // –†–∞—Å—á–µ—Ç –Ω–∞–≥—Ä–∞–¥—ã
            // –§–æ—Ä–º—É–ª–∞: –ë–∞–∑–∞ * (1.6 ^ (Stage-1))
            let baseGold = 5 * Math.pow(1.6, game.stage - 1);

            if (game.monster.isBoss) baseGold *= 10; // –ë–æ—Å—Å –¥–∞–µ—Ç —Ö10

            // –ë–æ–Ω—É—Å –æ—Ç –ø—Ä–æ–∫–∞—á–∫–∏ "–ê–ª—á–Ω–æ—Å—Ç—å"
            let bonusMulti = 1 + (game.stats.goldBonus / 100);
            let finalGold = Math.floor(baseGold * bonusMulti);

            let xpReward = 10 + (game.stage * 2);

            game.gold += finalGold;
            gainXp(xpReward);

            showFloatingText(0, window.innerHeight / 2 - 50, `+${formatNumber(finalGold)}üí∞`, 'reward');

            const m = document.getElementById('monster');
            m.classList.add('dead');

            setTimeout(() => {
                m.classList.remove('dead');

                // –õ–û–ì–ò–ö–ê –ü–†–û–ì–†–ï–°–°–ê
                if (game.monster.isBoss) {
                    // –£–±–∏–ª–∏ –±–æ—Å—Å–∞
                    if (game.stage === game.maxStage) {
                        game.maxStage++;
                    }
                    game.stage++; // –ü–µ—Ä–µ—Ö–æ–¥ –Ω–∞ —Å–ª–µ–¥ —É—Ä–æ–≤–µ–Ω—å
                    game.killsInStage = 0; // –°–±—Ä–æ—Å —Å—á–µ—Ç—á–∏–∫–∞

                    showFloatingText(window.innerWidth/2, window.innerHeight/2, "STAGE COMPLETED!", 'crit');
                } else {
                    // –£–±–∏–ª–∏ –æ–±—ã—á–Ω–æ–≥–æ
                    game.killsInStage++;
                }

                spawnMonster(true);
                saveGame();
            }, 400);
        }

        function spawnMonster(forceNew) {
            if (game.monster.hp > 0 && !forceNew) return;

            // 10-–π –º–æ–Ω—Å—Ç—Ä (–∏–Ω–¥–µ–∫—Å 9, –µ—Å–ª–∏ —Å—á–∏—Ç–∞—Ç—å 0..9) –∏–ª–∏ –ø—Ä–æ—Å—Ç–æ —Å—á–µ—Ç—á–∏–∫
            // –ï—Å–ª–∏ —É–±–∏—Ç–æ 9, –∑–Ω–∞—á–∏—Ç —Å–ª–µ–¥—É—é—â–∏–π (10-–π) - –±–æ—Å—Å.
            const isBossSpawn = (game.killsInStage >= 9);
            game.monster.isBoss = isBossSpawn;

            // HP —Ä–∞—Å—Ç–µ—Ç –æ—Ç —ç—Ç–∞–ø–∞
            let hpBase = 20 * Math.pow(1.6, game.stage - 1);

            if (isBossSpawn) {
                hpBase *= 10; // –ë–æ—Å—Å –∂–∏—Ä–Ω—ã–π
                game.monster.type = Math.floor(Math.random() * bosses.length);
            } else {
                game.monster.type = Math.floor(Math.random() * monsters.length);
            }

            game.monster.maxHp = Math.floor(hpBase);
            game.monster.hp = game.monster.maxHp;

            renderUI();
        }

        function gainXp(amount) {
            game.xp += amount;
            if (game.xp >= game.xpToNext) {
                game.level++;
                game.xp -= game.xpToNext;
                game.xpToNext = Math.floor(game.xpToNext * 1.5);
                tg.HapticFeedback.notificationOccurred('success');
            }
        }

        // === –ù–ê–í–ò–ì–ê–¶–ò–Ø –ü–û –≠–¢–ê–ü–ê–ú ===
        function changeStage(delta) {
            const newStage = game.stage + delta;

            // –ù–µ–ª—å–∑—è —É–π—Ç–∏ –Ω–∏–∂–µ 1 –∏ –≤—ã—à–µ –æ—Ç–∫—Ä—ã—Ç–æ–≥–æ –º–∞–∫—Å. —É—Ä–æ–≤–Ω—è
            if (newStage >= 1 && newStage <= game.maxStage) {
                game.stage = newStage;
                game.killsInStage = 0; // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å —É–±–∏–π—Å—Ç–≤ –ø—Ä–∏ —Å–º–µ–Ω–µ —ç—Ç–∞–ø–∞
                spawnMonster(true);
                renderUI();
            }
        }

        // === –ú–ê–ì–ê–ó–ò–ù ===

        function openTab(tabName) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.getElementById('tab-' + tabName).classList.add('active');
            tg.HapticFeedback.selectionChanged();
        }

        function upgrade(type) {
            const cost = game.costs[type];
            if (game.gold >= cost) {
                game.gold -= cost;

                if (type === 'damage') {
                    game.stats.damage += Math.ceil(game.stats.damage * 0.5); // +50% —Ç–µ–∫—É—â–µ–≥–æ —É—Ä–æ–Ω–∞
                    game.costs.damage = Math.floor(game.costs.damage * 1.5);
                } else if (type === 'crit') {
                    game.stats.critChance = Math.min(game.stats.critChance + 1, 75);
                    game.costs.crit = Math.floor(game.costs.crit * 1.6);
                } else if (type === 'ferocity') {
                    game.stats.critMulti = parseFloat((game.stats.critMulti + 0.1).toFixed(1));
                    game.costs.ferocity = Math.floor(game.costs.ferocity * 1.8);
                } else if (type === 'greed') {
                    game.stats.goldBonus += 10; // +10% –∑–æ–ª–æ—Ç–∞
                    game.costs.greed = Math.floor(game.costs.greed * 1.8);
                }
                saveAndRender();
            }
        }

        function upgradeAlly(type) {
            const ally = game.allies[type];
            if (game.gold >= ally.cost) {
                game.gold -= ally.cost;
                ally.lvl += 1;
                ally.cost = Math.floor(ally.cost * 1.4);
                saveAndRender();
            }
        }

        function saveAndRender() {
            tg.HapticFeedback.selectionChanged();
            renderUI();
            saveGame();
        }

        // === –û–¢–†–ò–°–û–í–ö–ê ===

        function showFloatingText(x, y, text, type) {
            const el = document.createElement('div');
            el.className = `damage-text ${type === 'crit' ? 'crit' : ''} ${type === 'reward' ? 'reward-text' : ''}`;
            el.innerText = text;

            // –ï—Å–ª–∏ x=0 (–¥–ª—è –Ω–∞–≥—Ä–∞–¥—ã), —Ü–µ–Ω—Ç—Ä–∏—Ä—É–µ–º CSS-–æ–º
            if (x > 0) {
                const rndX = (Math.random() - 0.5) * 60;
                el.style.left = (x + rndX) + 'px';
            } else {
                el.style.left = '0';
                el.style.width = '100%';
                el.style.textAlign = 'center';
            }

            el.style.top = y + 'px';
            document.body.appendChild(el);
            setTimeout(() => el.remove(), 600);
        }

        function animateMonsterHit() {
            const m = document.getElementById('monster');
            m.classList.remove('hit');
            void m.offsetWidth;
            m.classList.add('hit');
        }

        function formatNumber(num) {
            if (num >= 1000000000) return (num / 1000000000).toFixed(2) + 'B';
            if (num >= 1000000) return (num / 1000000).toFixed(2) + 'M';
            if (num >= 1000) return (num / 1000).toFixed(1) + 'k';
            return Math.floor(num);
        }

        function renderUI() {
            document.getElementById('gold').innerText = formatNumber(game.gold);
            document.getElementById('heroLvlText').innerText = `LVL ${game.level}`;
            document.getElementById('heroDpsText').innerText = `${formatNumber(calculateDps())} DPS`;

            const xpPct = Math.min(100, (game.xp / game.xpToNext) * 100);
            document.getElementById('xpBar').style.width = `${xpPct}%`;

            // –ù–∞–≤–∏–≥–∞—Ü–∏—è –∏ –≠—Ç–∞–ø—ã
            document.getElementById('stageNum').innerText = game.stage;
            document.getElementById('prevStageBtn').disabled = (game.stage <= 1);
            document.getElementById('nextStageBtn').disabled = (game.stage >= game.maxStage);

            // –ú–æ–Ω—Å—Ç—Ä –∏ —Å—á–µ—Ç—á–∏–∫
            const counterEl = document.getElementById('monsterCounter');
            const arena = document.getElementById('arena');

            if (game.monster.isBoss) {
                counterEl.innerText = "BOSS FIGHT";
                counterEl.style.color = "#e74c3c";
                document.getElementById('monster').innerText = bosses[game.monster.type % bosses.length];
                arena.classList.add('is-boss');
            } else {
                counterEl.innerText = `${game.killsInStage + 1} / 10`;
                counterEl.style.color = "#aaa";
                document.getElementById('monster').innerText = monsters[game.monster.type];
                arena.classList.remove('is-boss');
            }

            const hpPct = Math.max(0, (game.monster.hp / game.monster.maxHp) * 100);
            document.getElementById('hpBar').style.width = `${hpPct}%`;
            document.getElementById('hpText').innerText = `${formatNumber(game.monster.hp)} / ${formatNumber(game.monster.maxHp)}`;

            // –ö–Ω–æ–ø–∫–∏ –ì–µ—Ä–æ—è
            updateBtn('btnBuyDmg', game.costs.damage, game.gold);
            updateBtn('btnBuyCrit', game.costs.crit, game.gold);
            updateBtn('btnBuyFerocity', game.costs.ferocity, game.gold);
            updateBtn('btnBuyGreed', game.costs.greed, game.gold);

            // –ö–Ω–æ–ø–∫–∏ –ê—Ä–º–∏–∏
            updateBtn('btnBuyArcher', game.allies.archer.cost, game.gold);
            updateBtn('btnBuyMage', game.allies.mage.cost, game.gold);
            updateBtn('btnBuyKnight', game.allies.knight.cost, game.gold);
            updateBtn('btnBuyWarlock', game.allies.warlock.cost, game.gold);
            updateBtn('btnBuyTitan', game.allies.titan.cost, game.gold);
            updateBtn('btnBuyAngel', game.allies.angel.cost, game.gold);

            // –¢–µ–∫—Å—Ç—ã —Å—Ç–∞—Ç–æ–≤
            document.getElementById('dmgVal').innerText = formatNumber(game.stats.damage);
            document.getElementById('critVal').innerText = game.stats.critChance;
            document.getElementById('critMultiVal').innerText = game.stats.critMulti.toFixed(1);
            document.getElementById('greedVal').innerText = game.stats.goldBonus;

            document.getElementById('allyArcherLvl').innerText = game.allies.archer.lvl;
            document.getElementById('allyMageLvl').innerText = game.allies.mage.lvl;
            document.getElementById('allyKnightLvl').innerText = game.allies.knight.lvl;
            document.getElementById('allyWarlockLvl').innerText = game.allies.warlock.lvl;
            document.getElementById('allyTitanLvl').innerText = game.allies.titan.lvl;
            document.getElementById('allyAngelLvl').innerText = game.allies.angel.lvl;
        }

        function updateBtn(id, cost, balance) {
            const btn = document.getElementById(id);
            btn.innerText = `${formatNumber(cost)} üí∞`;
            btn.disabled = balance < cost;
        }

        initGame();

    </script>
</body>
</html>