<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Neon RPG Warlord</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        /* === –î–ò–ó–ê–ô–ù –ò –°–¢–ò–õ–ò === */
        :root {
            --bg-body: #000000;
            --bg-panel: #121214;
            --bg-card: #1c1c1e;
            --primary: #007aff;
            --accent: #ff9f0a;
            --danger: #ff453a;
            --essence: #bf5af2;
            --text-main: #ffffff;
            --text-sec: #8e8e93;
            --nav-height: 70px;
        }

        * {
            box-sizing: border-box;
            user-select: none;
            -webkit-user-select: none;
            -webkit-tap-highlight-color: transparent;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
        }

        body {
            margin: 0;
            background-color: var(--bg-body);
            background-image: radial-gradient(circle at 50% 30%, #1a1a2e 0%, #000000 70%);
            color: var(--text-main);
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* –í–µ—Ä—Ö–Ω—è—è –ø–∞–Ω–µ–ª—å */
        .hud {
            padding: 10px 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 10;
        }

        .resource-pill {
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            padding: 6px 12px;
            border-radius: 20px;
            display: flex;
            align-items: center;
            gap: 6px;
            font-weight: 700;
            font-size: 13px;
            border: 1px solid rgba(255,255,255,0.05);
        }

        .xp-bar-line {
            position: absolute; top: 0; left: 0; height: 3px; background: var(--primary);
            width: 0%; transition: width 0.3s; box-shadow: 0 0 10px var(--primary);
        }

        /* –ê—Ä–µ–Ω–∞ */
        .arena-container {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
            padding-bottom: 20px;
        }

        .monster-header { text-align: center; margin-bottom: 15px; }
        .monster-stage { font-size: 10px; text-transform: uppercase; letter-spacing: 2px; color: var(--text-sec); margin-bottom: 4px; }
        .monster-name { font-size: 18px; font-weight: 800; color: white; text-shadow: 0 2px 10px rgba(0,0,0,0.5); }
        .is-boss .monster-name { color: var(--danger); font-size: 22px; }

        .hp-container {
            width: 60%; height: 8px; background: #333; border-radius: 4px;
            overflow: hidden; margin-bottom: 20px; position: relative;
        }
        .hp-fill { height: 100%; width: 100%; background: var(--danger); transition: width 0.1s linear; }

        .sprite {
            font-size: 140px;
            filter: drop-shadow(0 10px 20px rgba(0,0,0,0.3));
            transition: transform 0.05s;
            cursor: pointer;
        }
        .sprite:active { transform: scale(0.92); }
        .sprite.hit { animation: shake 0.15s; }
        .sprite.dead { animation: die 0.3s forwards; }

        .nav-arrow {
            position: absolute; top: 50%; transform: translateY(-50%);
            font-size: 24px; padding: 20px; color: rgba(255,255,255,0.3);
            cursor: pointer;
        }
        .nav-left { left: 0; }
        .nav-right { right: 0; }

        /* –ù–∏–∂–Ω—è—è –ø–∞–Ω–µ–ª—å (–ú–µ–Ω—é) */
        .content-sheet {
            background: var(--bg-panel);
            border-top-left-radius: 24px;
            border-top-right-radius: 24px;
            height: 45vh;
            display: flex;
            flex-direction: column;
            box-shadow: 0 -5px 40px rgba(0,0,0,0.5);
            position: relative;
            z-index: 20;
            padding-bottom: var(--nav-height);
        }

        .sheet-header {
            padding: 15px;
            border-bottom: 1px solid rgba(255,255,255,0.05);
            display: flex; justify-content: space-between; align-items: center;
        }
        .sheet-title { font-weight: 800; font-size: 16px; color: var(--text-main); }
        .dps-meter { font-size: 11px; color: var(--text-sec); font-weight: 600; }
        .dps-val { color: var(--accent); }

        .scroll-area {
            flex-grow: 1;
            overflow-y: auto;
            padding: 15px;
        }

        /* –ö–∞—Ä—Ç–æ—á–∫–∏ */
        .list-item {
            display: flex;
            align-items: center;
            background: var(--bg-card);
            padding: 12px;
            border-radius: 16px;
            margin-bottom: 10px;
            border: 1px solid rgba(255,255,255,0.03);
        }

        .item-icon {
            width: 44px; height: 44px;
            background: rgba(255,255,255,0.05);
            border-radius: 12px;
            display: flex; align-items: center; justify-content: center;
            font-size: 20px;
            margin-right: 12px;
            flex-shrink: 0;
        }

        .item-info { flex-grow: 1; overflow: hidden; }
        .item-name { font-weight: 700; font-size: 13px; color: white; margin-bottom: 3px; }
        .item-meta { font-size: 11px; color: var(--text-sec); }
        .highlight { color: var(--accent); }

        .btn-buy {
            background: var(--primary);
            color: white;
            border: none;
            padding: 8px 14px;
            border-radius: 10px;
            font-weight: 700;
            font-size: 12px;
            min-width: 85px;
            text-align: center;
        }
        .btn-buy:disabled { background: #2c2c2e; color: #636366; }
        .btn-buy.essence { background: var(--essence); }

        /* –ù–∞–≤–∏–≥–∞—Ü–∏—è */
        .bottom-nav {
            position: fixed; bottom: 0; left: 0; width: 100%;
            height: var(--nav-height);
            background: rgba(18, 18, 20, 0.95);
            backdrop-filter: blur(20px);
            display: flex;
            justify-content: space-around;
            align-items: center;
            border-top: 1px solid rgba(255,255,255,0.05);
            z-index: 100;
            padding-bottom: 10px;
        }

        .nav-item {
            display: flex; flex-direction: column; align-items: center; gap: 4px;
            color: #636366; font-size: 10px; font-weight: 600;
            width: 20%; padding: 8px 0; cursor: pointer;
            transition: color 0.2s;
        }
        .nav-icon { font-size: 20px; margin-bottom: 2px; }
        .nav-item.active { color: var(--primary); }
        .nav-item.active .nav-icon { transform: scale(1.1); transition: transform 0.2s; }

        /* –°–µ—Ç–∫–∏ –∏ –∞–Ω–∏–º–∞—Ü–∏–∏ */
        .stats-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-bottom: 20px; }
        .stat-item {
            background: rgba(0,0,0,0.2); border: 1px solid rgba(255,255,255,0.08);
            border-radius: 10px; padding: 10px; text-align: center;
        }
        .stat-val { font-size: 18px; font-weight: 800; margin: 6px 0; color: white; }
        .btn-stat-up {
            width: 100%; padding: 4px; background: rgba(255,255,255,0.1);
            border: none; border-radius: 4px; color: white; font-size: 10px; font-weight: bold;
        }
        .stat-desc { font-size: 9px; color: var(--text-sec); margin-top: 4px; }

        .equip-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
        .equip-card { background: rgba(255,255,255,0.03); padding: 10px; border-radius: 12px; display: flex; align-items: center; gap: 10px; border: 1px solid rgba(255,255,255,0.05); }
        .equip-text h4 { margin: 0; font-size: 11px; color: var(--text-sec); }
        .equip-val { font-size: 12px; font-weight: bold; color: white; }
        .btn-equip-up {
            background: #27272a; color: white; border: 1px solid #3f3f46;
            padding: 4px 8px; border-radius: 6px; font-size: 10px; font-weight: bold; margin-left: auto;
        }

        .hidden { display: none !important; }
        .floater { position: absolute; pointer-events: none; font-weight: 900; animation: floatUp 0.8s forwards; z-index: 50; text-shadow: 0 2px 4px rgba(0,0,0,0.5); }
        .f-dmg { color: white; font-size: 24px; }
        .f-crit { color: var(--danger); font-size: 32px; }
        .f-gold { color: #ffd60a; width: 100%; text-align: center; left: 0; font-size: 20px; }
        .f-ess { color: var(--essence); width: 100%; text-align: center; left: 0; font-size: 24px; }

        @keyframes floatUp { to { transform: translateY(-80px); opacity: 0; } }
        @keyframes shake { 25% { transform: rotate(-5deg); } 75% { transform: rotate(5px); } }
        @keyframes die { to { transform: scale(0); opacity: 0; } }
    </style>
</head>
<body>

    <div class="xp-bar-line" id="xpBar"></div>

    <div class="hud">
        <div class="resource-pill"><span>üí∞</span> <span id="gold">0</span></div>
        <div class="resource-pill" style="border-color: rgba(191,90,242,0.3)"><span>üíé</span> <span id="essence">0</span></div>
    </div>

    <div class="arena-container">
        <div class="nav-arrow nav-left" id="prevStageBtn" onclick="changeStage(-1)">‚ùÆ</div>
        <div class="nav-arrow nav-right" id="nextStageBtn" onclick="changeStage(1)">‚ùØ</div>

        <div class="monster-header">
            <div class="monster-stage">STAGE <span id="stageNum">1</span></div>
            <div class="monster-name" id="monsterName">Loading...</div>
        </div>

        <div class="hp-container"><div class="hp-fill" id="hpBar"></div></div>
        <div class="sprite" id="monster" onpointerdown="attack(event)">üëæ</div>
    </div>

    <div class="content-sheet">
        <div class="sheet-header">
            <span class="sheet-title" id="tabTitle">–ì–µ—Ä–æ–π</span>
            <div class="dps-meter">DPS: <span id="totalDps" class="dps-val">0</span></div>
        </div>

        <div id="view-hero" class="scroll-area">
            <div style="text-align:center; margin-bottom:15px;">
                <h3 style="margin:0">LVL <span id="heroLvl">1</span></h3>
                <small style="color:#666">–û—á–∫–æ–≤: <span id="spCount" style="color:white">0</span></small>
            </div>
            <div class="stats-grid">
                <div class="stat-item"><div style="font-size:10px; color:var(--danger)">–°–ò–õ–ê</div><div class="stat-val" id="statStr">0</div><button class="btn-stat-up" onclick="buyAttribute('str')">+1</button><div class="stat-desc">+1% Dmg</div></div>
                <div class="stat-item"><div style="font-size:10px; color:var(--primary)">–õ–û–í–ö</div><div class="stat-val" id="statAgi">0</div><button class="btn-stat-up" onclick="buyAttribute('agi')">+1</button><div class="stat-desc">+0.5% Crit</div></div>
                <div class="stat-item"><div style="font-size:10px; color:#fbbf24">–£–î–ê–ß–ê</div><div class="stat-val" id="statLuk">0</div><button class="btn-stat-up" onclick="buyAttribute('luk')">+1</button><div class="stat-desc">+1% Gold</div></div>
            </div>
            <div style="margin-bottom:10px; font-weight:700; font-size:12px; color:var(--text-sec);">–≠–ö–ò–ü–ò–†–û–í–ö–ê</div>
            <div class="equip-grid" id="equipList"></div>
        </div>

        <div id="view-skills" class="scroll-area hidden"><div id="skillsList"></div></div>
        <div id="view-army" class="scroll-area hidden"><div id="alliesList"></div></div>
        <div id="view-workshop" class="scroll-area hidden"><div id="workshopList"></div></div>
        <div id="view-relics" class="scroll-area hidden"><div id="relicsList"></div></div>

        <div id="view-settings" class="scroll-area hidden">
            <div class="list-item" style="flex-direction:column; align-items:stretch">
                <h4 style="margin:0 0 10px 0">üéÅ –ü—Ä–æ–º–æ–∫–æ–¥</h4>
                <div style="display:flex; gap:10px">
                    <input type="text" id="promoInput" placeholder="CODE..." style="flex:1; background:#000; border:1px solid #333; color:white; padding:10px; border-radius:8px;">
                    <button class="btn-buy" onclick="activatePromo()">OK</button>
                </div>
                <p id="promoStatus" style="font-size:11px; margin:5px 0 0 0"></p>
            </div>
            <button class="list-item" style="width:100%; justify-content:center; color:var(--danger)" onclick="resetProgress()">–°–±—Ä–æ—Å –ø—Ä–æ–≥—Ä–µ—Å—Å–∞</button>
        </div>
    </div>

    <div class="bottom-nav">
        <div class="nav-item active" onclick="switchView('hero', this)"><span class="nav-icon">ü¶∏</span><span>–ì–µ—Ä–æ–π</span></div>
        <div class="nav-item" onclick="switchView('skills', this)"><span class="nav-icon">‚ö°</span><span>–ù–∞–≤—ã–∫–∏</span></div>
        <div class="nav-item" onclick="switchView('army', this)"><span class="nav-icon">‚öîÔ∏è</span><span>–ê—Ä–º–∏—è</span></div>
        <div class="nav-item" onclick="switchView('workshop', this)"><span class="nav-icon">üî®</span><span>–¶–µ—Ö</span></div>
        <div class="nav-item" onclick="switchView('relics', this)"><span class="nav-icon">üîÆ</span><span>–†–µ–ª–∏–∫</span></div>
        <div class="nav-item" onclick="switchView('settings', this)"><span class="nav-icon">‚öôÔ∏è</span><span>–ú–µ–Ω—é</span></div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();

        // === CONFIGURATION ===
        const initialState = {
            gold: 0, essence: 0, level: 1, xp: 0, xpToNext: 150, statPoints: 0,
            stage: 1, maxStage: 1, killsInStage: 0,
            attributes: { str: 0, agi: 0, luk: 0 },
            equipment: { head: 0, chest: 0, legs: 0, boots: 0, weapon: 0, shield: 0 },
            stats: { damage: 1, critChance: 0, critMulti: 2.0, goldBonus: 0, doubleStrike: 0, luckyStrike: 0 },

            allies: {
                archer: { lvl: 0, dpsBase: 5, cost: 100, name: "–õ—É—á–Ω–∏–∫", icon: "üèπ" },
                mage: { lvl: 0, dpsBase: 25, cost: 600, name: "–ú–∞–≥ –û–≥–Ω—è", icon: "üî•" },
                knight: { lvl: 0, dpsBase: 100, cost: 3000, name: "–†—ã—Ü–∞—Ä—å", icon: "üõ°Ô∏è" },
                warlock: { lvl: 0, dpsBase: 500, cost: 20000, name: "–ù–µ–∫—Ä–æ–º–∞–Ω—Ç", icon: "üíÄ" },
                titan: { lvl: 0, dpsBase: 2500, cost: 150000, name: "–¢–∏—Ç–∞–Ω", icon: "üóø" },
                angel: { lvl: 0, dpsBase: 10000, cost: 1000000, name: "–ê–Ω–≥–µ–ª", icon: "üëº" },
                zeus: { lvl: 0, dpsBase: 50000, cost: 50000000, name: "–ó–µ–≤—Å", icon: "‚ö°" }
            },
            workshop: {
                archerBoost: { level: 0, multi: 0.2, cost: 1500, name: "–õ—É—á–Ω–∏–∫–∏", icon: "üéØ" },
                mageBoost: { level: 0, multi: 0.2, cost: 7000, name: "–ú–∞–≥–∏", icon: "üîÆ" },
                knightBoost: { level: 0, multi: 0.2, cost: 30000, name: "–†—ã—Ü–∞—Ä–∏", icon: "‚öîÔ∏è" },
                warlockBoost: { level: 0, multi: 0.2, cost: 150000, name: "–ù–µ–∫—Ä–æ–º–∞–Ω—Ç—ã", icon: "‚ö∞Ô∏è" },
                titanBoost: { level: 0, multi: 0.2, cost: 800000, name: "–¢–∏—Ç–∞–Ω—ã", icon: "‚õ∞Ô∏è" },
                angelBoost: { level: 0, multi: 0.2, cost: 5000000, name: "–ê–Ω–≥–µ–ª—ã", icon: "‚ú®" },
                zeusBoost: { level: 0, multi: 0.2, cost: 200000000, name: "–ë–æ–≥–∏", icon: "üå©Ô∏è" },
                bossSlayer: { level: 0, multi: 0.1, cost: 15000, name: "–£–±–∏–π—Ü–∞ –ë–æ—Å—Å–æ–≤", icon: "üê≤" }
            },
            relics: {
                titanSword: { level: 0, multi: 0.1, cost: 1, name: "–ú–µ—á –¢–∏—Ç–∞–Ω–∞", icon: "üó°Ô∏è" },
                goldHorn: { level: 0, multi: 0.1, cost: 1, name: "–†–æ–≥ –ò–∑–æ–±–∏–ª–∏—è", icon: "üìØ" },
                fatalStrike: { level: 0, chance: 1, cost: 5, name: "–û–∫–æ –ë–µ–∑–¥–Ω—ã", icon: "üßø" },
                wisdomOrb: { level: 0, multi: 0.1, cost: 2, name: "–ö–Ω–∏–≥–∞ –ú—É–¥—Ä–æ—Å—Ç–∏", icon: "üìò" },
                soulPrism: { level: 0, chance: 1, cost: 5, name: "–ü—Ä–∏–∑–º–∞ –î—É—à–∏", icon: "üíé" }
            },
            costs: { damage: 10, crit: 50, ferocity: 200, greed: 500, doubleStrike: 2000, luckyStrike: 3000 },
            monster: { hp: 20, maxHp: 20, type: 0, prefix: 0, isBoss: false }
        };

        const equipConfig = {
            head: { icon: "ü™ñ", name: "–®–ª–µ–º", bonus: "XP" },
            chest: { icon: "üëï", name: "–ë—Ä–æ–Ω—è", bonus: "Gold" },
            weapon: { icon: "‚öîÔ∏è", name: "–û—Ä—É–∂–∏–µ", bonus: "Dmg" },
            shield: { icon: "üõ°Ô∏è", name: "–©–∏—Ç", bonus: "Boss" },
            legs: { icon: "üëñ", name: "–®—Ç–∞–Ω—ã", bonus: "Ess" },
            boots: { icon: "üë¢", name: "–°–∞–ø–æ–≥–∏", bonus: "Crit" }
        };
        const equipCosts = [{g: 1000, e: 0}, {g: 5000, e: 1}, {g: 25000, e: 5}, {g: 100000, e: 10}, {g: 500000, e: 25}, {g: 2500000, e: 50}, {g: 10000000, e: 100}];
        const equipNames = ["–ù–µ—Ç", "–í–µ—Ç—Ö–∏–π", "–û–±—ã—á–Ω—ã–π", "–†–µ–¥–∫–∏–π", "–≠–ø–∏—á–µ—Å–∫–∏–π", "–õ–µ–≥–µ–Ω–¥–∞—Ä–Ω—ã–π", "–ú–∏—Ñ–∏—á–µ—Å–∫–∏–π", "–ë–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–π"];

        let game = JSON.parse(JSON.stringify(initialState));
        let usedCodes = [];
        let isCloudLoading = true;

        const monsters = ["–°–ª–∞–π–º", "–ì–æ–±–ª–∏–Ω", "–°–∫–µ–ª–µ—Ç", "–ü—Ä–∏–∑—Ä–∞–∫", "–û—Ä–∫", "–í–æ–ª–∫", "–í–∞–º–ø–∏—Ä", "–ó–æ–º–±–∏"];
        const bosses = ["–î—Ä–∞–∫–æ–Ω", "–ö—Ä–∞–∫–µ–Ω", "–î–µ–º–æ–Ω", "–ì–∏–≥–∞–Ω—Ç", "–õ–∏—á", "–¢–∏—Ç–∞–Ω"];
        const prefixes = ["", "–ó–ª–æ–π ", "–î–∏–∫–∏–π ", "–î—Ä–µ–≤–Ω–∏–π ", "–¢–µ–º–Ω—ã–π ", "–õ–µ–¥—è–Ω–æ–π ", "–û–≥–Ω–µ–Ω–Ω—ã–π ", "–¢–æ–∫—Å–∏—á–Ω—ã–π "];
        const monsterEmojis = ["üëæ", "üë∫", "üíÄ", "üëª", "üëπ", "üê∫", "üßõ", "üßü"];
        const bossEmojis = ["üê≤", "üêô", "üëø", "üóø", "üßô‚Äç‚ôÇÔ∏è", "ü¶ç"];

        // === SAFE LOAD ===
        function safeMerge(target, source) {
            if (!source) return target;
            for (const key of Object.keys(target)) {
                if (source[key] !== undefined) {
                    if (typeof target[key] === 'object' && target[key] !== null && !Array.isArray(target[key])) {
                        safeMerge(target[key], source[key]);
                    } else {
                        target[key] = source[key];
                    }
                }
            }
            return target;
        }

        function initGame() {
            try {
                tg.CloudStorage.getItem('rpg_save_v10_fix', (err, value) => {
                    if (!err && value) safeMerge(game, JSON.parse(value));
                    else {
                        // Fallback logic
                        const old = localStorage.getItem('rpg_save_v9_equip') || localStorage.getItem('rpg_save_v10_ui');
                        if(old) safeMerge(game, JSON.parse(old));
                    }
                    const codes = localStorage.getItem('rpg_used_codes');
                    if(codes) usedCodes = JSON.parse(codes);

                    isCloudLoading = false;
                    renderStaticLists();
                    renderUI(); // Force update
                    spawnMonster(false);
                });
            } catch (e) { localStorage.clear(); location.reload(); }
        }

        function saveGame() {
            if (isCloudLoading) return;
            const dataStr = JSON.stringify(game);
            localStorage.setItem('rpg_save_v10_fix', dataStr);
            tg.CloudStorage.setItem('rpg_save_v10_fix', dataStr);
        }
        setInterval(saveGame, 60000);

        // === RENDERERS (LISTS) ===
        function renderStaticLists() {
            // Equipment
            let eqHtml = '';
            for(let slot in equipConfig) {
                eqHtml += `<div class="equip-card"><div class="slot-icon">${equipConfig[slot].icon}</div><div style="flex:1"><div class="equip-text"><h4 id="eqName_${slot}">–ù–µ—Ç</h4></div><div class="equip-val" id="eqBonus_${slot}">+0%</div></div><button class="btn-buy" id="btnEq_${slot}" onclick="upgradeEquipment('${slot}')" style="padding:4px 8px; font-size:10px">UP</button></div>`;
            }
            document.getElementById('equipList').innerHTML = eqHtml;

            // Skills
            const skills = [
                {id:'damage', n:'–ê—Ç–∞–∫–∞', i:'‚öîÔ∏è', d:'–£—Ä–æ–Ω –∫–ª–∏–∫–∞', v:'dmgVal'},
                {id:'crit', n:'–ú–µ—Ç–∫–æ—Å—Ç—å', i:'üéØ', d:'–ö—Ä–∏—Ç —à–∞–Ω—Å', v:'critVal'},
                {id:'ferocity', n:'–ñ–µ—Å—Ç–æ–∫–æ—Å—Ç—å', i:'ü©∏', d:'–ö—Ä–∏—Ç —É—Ä–æ–Ω', v:'critMultiVal'},
                {id:'doubleStrike', n:'–î–≤–æ–π–Ω–æ–π —É–¥–∞—Ä', i:'‚ö°', d:'–®–∞–Ω—Å x2 —É–¥–∞—Ä–∞', v:'doubleStrikeVal'},
                {id:'greed', n:'–ê–ª—á–Ω–æ—Å—Ç—å', i:'üí∞', d:'–ë–æ–Ω—É—Å –∑–æ–ª–æ—Ç–∞', v:'greedVal'},
                {id:'luckyStrike', n:'–£–¥–∞—á–∞', i:'üçÄ', d:'–®–∞–Ω—Å x2 –∑–æ–ª–æ—Ç–∞', v:'luckVal'}
            ];
            let skHtml = '';
            skills.forEach(s => {
                skHtml += `<div class="list-item"><div class="item-icon">${s.i}</div><div class="item-info"><div class="item-name">${s.n}</div><div class="item-meta">${s.d}: <span id="${s.v}" class="highlight">0</span></div></div><button class="btn-buy" id="btnBuy_${s.id}" onclick="upgrade('${s.id}')">Loading...</button></div>`;
            });
            document.getElementById('skillsList').innerHTML = skHtml;

            // Allies
            let alHtml = '';
            for(let k in game.allies) {
                const u = game.allies[k];
                const icon = u.icon || "‚ùì";
                alHtml += `<div class="list-item"><div class="item-icon">${icon}</div><div class="item-info"><div class="item-name">${u.name}</div><div class="item-meta">DPS: <span id="dps_${k}">0</span> | Lv: <span id="lvl_${k}">0</span></div></div><button class="btn-buy" id="btnBuyUnit_${k}" onclick="upgradeAlly('${k}')">Loading...</button></div>`;
            }
            document.getElementById('alliesList').innerHTML = alHtml;

            // Workshop
            let wsHtml = '';
            for(let k in game.workshop) {
                const w = game.workshop[k];
                const icon = w.icon || "üî®";
                wsHtml += `<div class="list-item"><div class="item-icon">${icon}</div><div class="item-info"><div class="item-name">${w.name}</div><div class="item-meta highlight">–ë–æ–Ω—É—Å: +<span id="techVal_${k}">0</span>%</div></div><button class="btn-buy" id="btnBuyTech_${k}" onclick="upgradeTech('${k}')">Loading...</button></div>`;
            }
            document.getElementById('workshopList').innerHTML = wsHtml;

            // Relics
            let rlHtml = '';
            for(let k in game.relics) {
                const r = game.relics[k];
                const icon = r.icon || "üîÆ";
                rlHtml += `<div class="list-item" style="border-color:var(--essence)"><div class="item-icon">${icon}</div><div class="item-info"><div class="item-name" style="color:var(--essence)">${r.name}</div><div class="item-meta">–≠—Ñ—Ñ–µ–∫—Ç: <span id="relicVal_${k}">0</span></div></div><button class="btn-buy essence" id="btnBuyRelic_${k}" onclick="upgradeRelic('${k}')">Loading...</button></div>`;
            }
            document.getElementById('relicsList').innerHTML = rlHtml;
        }

        // === LOGIC ===
        function switchView(viewId, btn) {
            document.querySelectorAll('.scroll-area').forEach(el => el.classList.add('hidden'));
            document.getElementById('view-'+viewId).classList.remove('hidden');
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            btn.classList.add('active');
            const titles = { hero: "–ì–µ—Ä–æ–π", skills: "–ù–∞–≤—ã–∫–∏", army: "–ê—Ä–º–∏—è", workshop: "–ú–∞—Å—Ç–µ—Ä—Å–∫–∞—è", relics: "–†–µ–ª–∏–∫–≤–∏–∏", settings: "–ù–∞—Å—Ç—Ä–æ–π–∫–∏" };
            document.getElementById('tabTitle').innerText = titles[viewId];
        }

        function getAttrDmg() { return 1 + (game.attributes.str * 0.01); }
        function getAttrCrit() { return game.attributes.agi * 0.5; }
        function getAttrGold() { return 1 + (game.attributes.luk * 0.01); }

        function getEquipBonuses() {
            return {
                xp: 1 + (game.equipment.head * 0.1),
                gold: 1 + (game.equipment.chest * 0.1),
                essence: (game.equipment.legs * 0.5),
                crit: (game.equipment.boots * 1),
                click: 1 + (game.equipment.weapon * 0.2),
                boss: 1 + (game.equipment.shield * 0.15)
            };
        }

        function getGlobalDamageMulti() { return (1 + (game.relics.titanSword.level * game.relics.titanSword.multi)) * getAttrDmg(); }
        function getGlobalGoldMulti() { return (1 + (game.relics.goldHorn.level * game.relics.goldHorn.multi)) * getAttrGold() * getEquipBonuses().gold; }

        function getAllyDps(type) {
            const ally = game.allies[type];
            let dps = ally.lvl * ally.dpsBase;
            const techKey = type + 'Boost';
            if (game.workshop[techKey]) dps *= (1 + (game.workshop[techKey].level * game.workshop[techKey].multi));
            return dps * getGlobalDamageMulti();
        }

        function calculateTotalDps() {
            let total = 0;
            for (let key in game.allies) total += getAllyDps(key);
            return total;
        }

        function getHeroClickDamage() {
            let dmg = game.stats.damage;
            const eq = getEquipBonuses();
            if (game.monster.isBoss) dmg *= (1 + (game.workshop.bossSlayer.level * game.workshop.bossSlayer.multi)) * eq.boss;
            return dmg * getGlobalDamageMulti() * eq.click;
        }

        setInterval(() => {
            if (isCloudLoading) return;
            const dps = calculateTotalDps();
            if (dps > 0 && game.monster.hp > 0) dealDamage(dps / 10, false, false);
        }, 100);

        function attack(e) {
            if (isCloudLoading || game.monster.hp <= 0) return;
            let damage = getHeroClickDamage();
            let isCrit = Math.random() * 100 < (game.stats.critChance + getAttrCrit() + getEquipBonuses().crit);
            let isFatal = !isCrit && Math.random() * 100 < (game.relics.fatalStrike.level * game.relics.fatalStrike.chance);

            if (isFatal) damage *= 10;
            if (isCrit) damage = Math.floor(damage * game.stats.critMulti);

            tg.HapticFeedback.impactOccurred(isFatal ? 'heavy' : (isCrit ? 'medium' : 'light'));
            dealDamage(damage, true, isCrit, e.clientX, e.clientY, isFatal);

            if (Math.random() * 100 < game.stats.doubleStrike && game.monster.hp > 0) {
                setTimeout(() => dealDamage(damage, true, isCrit, e.clientX+40, e.clientY-30, isFatal), 80);
            }
        }

        function dealDamage(amount, isClick, isCrit, x, y, isFatal) {
            game.monster.hp -= amount;
            if (isClick) {
                let type = isFatal ? 'f-ess' : (isCrit ? 'f-crit' : 'f-dmg');
                let text = formatNumber(Math.floor(amount));
                if (isFatal) text = "‚ò†Ô∏è " + text;
                showFloatingText(x, y, text, type);
                const s = document.getElementById('monster');
                s.classList.remove('hit'); void s.offsetWidth; s.classList.add('hit');
            }
            if (game.monster.hp <= 0) { game.monster.hp = 0; killMonster(); }
            renderUI();
        }

        function killMonster() {
            tg.HapticFeedback.notificationOccurred('success');
            let baseGold = 5 * Math.pow(1.6, game.stage - 1);
            if (game.monster.isBoss) baseGold *= 10;
            let bonusMulti = (1 + (game.stats.goldBonus / 100)) * getGlobalGoldMulti();
            if (Math.random() * 100 < game.stats.luckyStrike) bonusMulti *= 2;
            let finalGold = Math.floor(baseGold * bonusMulti);
            game.gold += finalGold;

            let essenceDrop = 0;
            if (game.monster.isBoss) {
                essenceDrop = 1;
                if (game.stage % 10 === 0) essenceDrop++;
                if (Math.random() * 100 < (game.relics.soulPrism.level * game.relics.soulPrism.chance + getEquipBonuses().essence)) essenceDrop++;
                game.essence += essenceDrop;
            }

            let xpReward = (15 + (game.stage * 4)) * (1 + (game.relics.wisdomOrb.level * game.relics.wisdomOrb.multi)) * getEquipBonuses().xp;
            gainXp(Math.floor(xpReward));

            showFloatingText(window.innerWidth/2, window.innerHeight/2-100, `+${formatNumber(finalGold)}üí∞`, 'f-gold');
            if (essenceDrop > 0) setTimeout(() => showFloatingText(window.innerWidth/2, window.innerHeight/2-140, `+${essenceDrop}üíé`, 'f-ess'), 200);

            const m = document.getElementById('monster');
            m.classList.add('dead');
            setTimeout(() => {
                m.classList.remove('dead');
                if (game.monster.isBoss) {
                    if (game.stage === game.maxStage) game.maxStage++;
                    game.stage++; game.killsInStage = 0; saveGame();
                } else { game.killsInStage++; }
                spawnMonster(true);
            }, 350);
        }

        function spawnMonster(forceNew) {
            if (game.monster.hp > 0 && !forceNew) return;
            const isBoss = (game.killsInStage >= 9);
            game.monster.isBoss = isBoss;
            let hpBase = 30 * Math.pow(1.6, game.stage - 1);
            if (isBoss) {
                hpBase *= 15;
                game.monster.type = Math.floor(Math.random() * bosses.length);
            } else {
                game.monster.type = Math.floor(Math.random() * monsters.length);
                game.monster.prefix = Math.random() > 0.7 ? Math.floor(Math.random() * (prefixes.length - 1)) + 1 : 0;
            }
            game.monster.maxHp = Math.floor(hpBase);
            game.monster.hp = game.monster.maxHp;
            renderUI();
        }

        function gainXp(amount) {
            game.xp += amount;
            if (game.xp >= game.xpToNext) {
                game.level++; game.statPoints += 3;
                game.xp -= game.xpToNext; game.xpToNext = Math.floor(game.xpToNext * 1.6);
                tg.HapticFeedback.notificationOccurred('success');
                renderUI();
            }
        }

        function buyAttribute(attr) {
            if (game.statPoints > 0) { game.statPoints--; game.attributes[attr]++; saveAndRender(); }
        }

        function upgrade(type) {
            const cost = game.costs[type];
            if (game.gold >= cost) {
                game.gold -= cost;
                if (type === 'damage') { game.stats.damage += Math.ceil(game.stats.damage * 0.5); game.costs.damage = Math.floor(game.costs.damage * 1.8); }
                else if (type === 'crit') { game.stats.critChance++; game.costs.crit = Math.floor(game.costs.crit * 1.6); }
                else if (type === 'ferocity') { game.stats.critMulti += 0.1; game.costs.ferocity *= 2; }
                else if (type === 'greed') { game.stats.goldBonus += 10; game.costs.greed *= 2; }
                else if (type === 'doubleStrike') { game.stats.doubleStrike += 5; game.costs.doubleStrike *= 2; }
                else if (type === 'luckyStrike') { game.stats.luckyStrike += 2; game.costs.luckyStrike *= 3; }
                saveAndRender();
            }
        }

        function upgradeAlly(type) {
            const ally = game.allies[type];
            if (game.gold >= ally.cost) { game.gold -= ally.cost; ally.lvl++; ally.cost = Math.floor(ally.cost * 1.5); saveAndRender(); }
        }

        function upgradeTech(type) {
            const tech = game.workshop[type];
            if (game.gold >= tech.cost) { game.gold -= tech.cost; tech.level++; tech.cost = Math.floor(tech.cost * 3); saveAndRender(); }
        }

        function upgradeRelic(type) {
            const relic = game.relics[type];
            if (game.essence >= relic.cost) { game.essence -= relic.cost; relic.level++; relic.cost++; saveAndRender(); }
        }

        function upgradeEquipment(slot) {
            const lvl = game.equipment[slot];
            if (lvl >= 7) return;
            const c = equipCosts[lvl];
            if (game.gold >= c.g && game.essence >= c.e) {
                game.gold -= c.g; game.essence -= c.e; game.equipment[slot]++;
                tg.HapticFeedback.notificationOccurred('success'); saveAndRender();
            }
        }

        function changeStage(d) {
            const n = game.stage + d;
            if (n >= 1 && n <= game.maxStage) { game.stage = n; game.killsInStage = 0; spawnMonster(true); saveGame(); renderUI(); }
        }

        function activatePromo() {
            const input = document.getElementById('promoInput');
            const code = input.value.trim().toUpperCase();
            if(!code || usedCodes.includes(code)) { document.getElementById('promoStatus').innerText = "‚ùå"; return; }
            let ok = false;
            if(code.startsWith("GOLD-")) { game.gold += parseInt(code.split("-")[1]); ok = true; }
            else if(code.startsWith("ESS-")) { game.essence += parseInt(code.split("-")[1]); ok = true; }
            else if(code.startsWith("UNIT-ZEUS-")) {
                if(game.allies.zeus.lvl === 0) game.allies.zeus.lvl = 1; else game.gold += 50000000;
                ok = true;
            }
            if(ok) {
                usedCodes.push(code); localStorage.setItem('rpg_used_codes', JSON.stringify(usedCodes));
                document.getElementById('promoStatus').innerText = "‚úÖ OK"; input.value = "";
                tg.HapticFeedback.notificationOccurred('success'); saveAndRender();
            }
        }

        function resetProgress() { if(confirm("Reset?")) { localStorage.clear(); location.reload(); } }
        function saveAndRender() { tg.HapticFeedback.selectionChanged(); renderUI(); saveGame(); }

        function formatNumber(num) {
            if (num >= 1e9) return (num / 1e9).toFixed(2) + 'B';
            if (num >= 1e6) return (num / 1e6).toFixed(2) + 'M';
            if (num >= 1e3) return (num / 1e3).toFixed(1) + 'k';
            return Math.floor(num);
        }
        function showFloatingText(x, y, text, cls) {
            const el = document.createElement('div'); el.className = `floater ${cls}`; el.innerText = text;
            if(!cls.includes('f-gold') && !cls.includes('f-ess')) { const r = (Math.random()-0.5)*60; el.style.left = (x+r)+'px'; el.style.top = y+'px'; }
            else { el.style.top = y+'px'; }
            document.body.appendChild(el); setTimeout(() => el.remove(), 800);
        }

        // === MAIN RENDERER ===
        function renderUI() {
            // Stats
            document.getElementById('gold').innerText = formatNumber(game.gold);
            document.getElementById('essence').innerText = formatNumber(game.essence);
            document.getElementById('heroLvl').innerText = game.level;
            document.getElementById('spCount').innerText = game.statPoints;

            document.getElementById('statStr').innerText = game.attributes.str;
            document.getElementById('statAgi').innerText = game.attributes.agi;
            document.getElementById('statLuk').innerText = game.attributes.luk;

            const clickDmg = getHeroClickDamage();
            const idleDps = calculateTotalDps();
            document.getElementById('clickDmgText').innerText = formatNumber(clickDmg);
            document.getElementById('idleDpsText').innerText = formatNumber(idleDps);
            document.getElementById('totalDps').innerText = formatNumber(idleDps);

            // Monster
            const m = game.monster;
            const ar = document.getElementById('arena');
            const mn = document.getElementById('monsterName');
            const ms = document.getElementById('monster');
            const mc = document.getElementById('monsterCounter');

            if(m.isBoss) {
                mc.innerText = "BOSS FIGHT"; mc.style.color = "var(--danger)";
                mn.innerText = bosses[m.type % bosses.length];
                ms.innerText = bossEmojis[m.type % bossEmojis.length];
                ar.classList.add('is-boss');
            } else {
                mc.innerText = `${game.killsInStage+1} / 10`; mc.style.color = "var(--text-sec)";
                mn.innerText = prefixes[m.prefix] + monsters[m.type % monsters.length];
                ms.innerText = monsterEmojis[m.type % monsterEmojis.length];
                ar.classList.remove('is-boss');
            }
            document.getElementById('hpBar').style.width = Math.max(0, (m.hp/m.maxHp)*100)+'%';
            document.getElementById('stageNum').innerText = game.stage;
            document.getElementById('prevStageBtn').style.opacity = game.stage<=1 ? 0.2 : 1;
            document.getElementById('nextStageBtn').style.opacity = game.stage>=game.maxStage ? 0.2 : 1;

            // UPDATES
            const upgBtn = (id, c, e=false) => { const b=document.getElementById(id); if(b) { b.innerText = "üí∞ " + formatNumber(c)+(e?' üíé':''); b.disabled = e ? game.essence<c : game.gold<c; }};
            const updateTxt = (id, txt) => { const el=document.getElementById(id); if(el) el.innerText=txt; };

            // Skills
            upgBtn('btnBuy_damage', game.costs.damage); updateTxt('dmgVal', formatNumber(game.stats.damage));
            upgBtn('btnBuy_crit', game.costs.crit); updateTxt('critVal', game.stats.critChance);
            upgBtn('btnBuy_ferocity', game.costs.ferocity); updateTxt('critMultiVal', game.stats.critMulti.toFixed(1));
            upgBtn('btnBuy_doubleStrike', game.costs.doubleStrike); updateTxt('doubleStrikeVal', game.stats.doubleStrike);
            upgBtn('btnBuy_greed', game.costs.greed); updateTxt('greedVal', game.stats.goldBonus);
            upgBtn('btnBuy_luckyStrike', game.costs.luckyStrike); updateTxt('luckVal', game.stats.luckyStrike);

            // Lists
            for(let k in game.allies) {
                upgBtn(`btnBuyUnit_${k}`, game.allies[k].cost);
                updateTxt(`dps_${k}`, formatNumber(getAllyDps(k)));
                updateTxt(`lvl_${k}`, game.allies[k].lvl);
            }
            for(let k in game.workshop) {
                upgBtn(`btnBuyTech_${k}`, game.workshop[k].cost);
                updateTxt(`techVal_${k}`, Math.round(game.workshop[k].level*game.workshop[k].multi*100));
            }
            for(let k in game.relics) {
                const b=document.getElementById(`btnBuyRelic_${k}`); if(b) { b.innerText = "üíé " + game.relics[k].cost; b.disabled = game.essence < game.relics[k].cost; }
                if(k.includes('fatal')||k.includes('soul')) updateTxt(`relicVal_${k}`, (game.relics[k].level*game.relics[k].chance)+'%');
                else updateTxt(`relicVal_${k}`, 'x'+(1+game.relics[k].level*game.relics[k].multi).toFixed(1));
            }

            // Equipment
            const eq = getEquipBonuses();
            updateTxt('eqBonus_head', `+${Math.round((eq.xp-1)*100)}% XP`);
            updateTxt('eqBonus_chest', `+${Math.round((eq.gold-1)*100)}% Gold`);
            updateTxt('eqBonus_weapon', `x${eq.click.toFixed(1)} Click`);
            updateTxt('eqBonus_shield', `+${Math.round((eq.boss-1)*100)}% Boss`);
            updateTxt('eqBonus_legs', `+${eq.essence.toFixed(1)}% Ess`);
            updateTxt('eqBonus_boots', `+${eq.crit}% Crit`);

            for(let s in game.equipment) {
                const l = game.equipment[s];
                const elN = document.getElementById(`eqName_${s}`);
                elN.innerText = `${equipNames[l]} (+${l})`;
                elN.style.color = l>=6?'#fbbf24':(l>=4?'#bf5af2':(l>=2?'#007aff':'white'));
                const btn = document.getElementById(`btnEq_${s}`);
                if(l>=7) { btn.innerText="MAX"; btn.disabled=true; }
                else {
                    const c = equipCosts[l];
                    btn.innerText = `üí∞${formatNumber(c.g)}${c.e?' üíé'+c.e:''}`;
                    btn.disabled = (game.gold < c.g || game.essence < c.e);
                }
            }
        }
    </script>
</body>
</html>