<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>RPG Legend Clicker</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * {
            -webkit-tap-highlight-color: transparent;
            outline: none;
            user-select: none;
            -webkit-user-select: none;
            box-sizing: border-box;
        }

        :root {
            --bg-color: #0f0f10;
            --card-bg: #1c1c1e;
            --accent: #ff9f0a;
            --essence-color: #bf5af2;
            --hp-color: #ff453a;
            --xp-color: #0a84ff;
            --text-primary: #ffffff;
            --text-secondary: #8e8e93;
            --tab-active-bg: rgba(255, 159, 10, 0.15);
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-primary);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        #saveStatus {
            position: absolute;
            top: 90px;
            right: 10px;
            font-size: 10px;
            color: #30d158;
            opacity: 0;
            transition: opacity 0.5s;
            z-index: 20;
            font-weight: 700;
            text-transform: uppercase;
            background: rgba(0,0,0,0.7);
            padding: 2px 6px;
            border-radius: 4px;
        }

        /* --- HEADER --- */
        .hero-panel {
            padding: 12px 16px;
            background: rgba(28, 28, 30, 0.95);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid #333;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 5px;
            z-index: 10;
            position: relative;
        }

        .hero-stats-left { display: flex; flex-direction: column; justify-content: center; }
        .hero-stats-right { text-align: right; display: flex; flex-direction: column; justify-content: center; gap: 2px; }

        .hero-lvl { color: var(--accent); font-size: 14px; font-weight: 800; margin-bottom: 4px;}

        /* –°—Ç–∏–ª–∏ –¥–ª—è –ø–æ–∫–∞–∑–∞—Ç–µ–ª–µ–π —É—Ä–æ–Ω–∞ */
        .damage-display {
            font-size: 11px;
            font-weight: 600;
            display: flex;
            flex-direction: column;
            gap: 2px;
        }
        .dmg-row { display: flex; align-items: center; gap: 5px; }
        .click-dmg { color: #ff453a; }
        .idle-dps { color: #ffd60a; }

        .currency-row { font-size: 15px; font-weight: 800; letter-spacing: 0.5px; display: flex; align-items: center; justify-content: flex-end; gap: 5px; }
        .gold-val { color: #ffd60a; }
        .essence-val { color: var(--essence-color); text-shadow: 0 0 10px rgba(191, 90, 242, 0.4); }

        .xp-container {
            height: 3px;
            width: 100%;
            background: #333;
            position: absolute;
            bottom: 0;
            left: 0;
        }
        .xp-bar {
            height: 100%;
            background: var(--xp-color);
            width: 0%;
            transition: width 0.3s;
            box-shadow: 0 0 8px var(--xp-color);
        }

        /* --- ARENA --- */
        .arena {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            position: relative;
            background: radial-gradient(circle at 50% 40%, #2c3e50 0%, #000000 80%);
        }

        .stage-nav {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 5px;
            z-index: 10;
        }
        .nav-btn {
            background: rgba(255,255,255,0.08);
            border: 1px solid rgba(255,255,255,0.1);
            color: white;
            width: 40px;
            height: 32px;
            border-radius: 8px;
            font-size: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }
        .nav-btn:disabled { opacity: 0.2; pointer-events: none; }

        .stage-info { text-align: center; }
        .stage-title { font-size: 9px; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 1px; }
        .stage-number { font-size: 24px; font-weight: 900; color: var(--accent); }

        .monster-counter {
            font-size: 11px;
            color: #666;
            margin-bottom: 5px;
            background: rgba(255,255,255,0.05);
            padding: 2px 8px;
            border-radius: 8px;
        }

        .monster-container {
            position: relative;
            z-index: 5;
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
        }

        .hp-bar-container {
            width: 240px;
            height: 16px;
            background: #2c2c2e;
            border-radius: 4px;
            overflow: hidden;
            position: relative;
            margin-bottom: 10px;
            z-index: 10;
            border: 1px solid rgba(255,255,255,0.1);
        }
        .hp-bar {
            width: 100%;
            height: 100%;
            background: var(--hp-color);
            transition: width 0.1s linear;
        }
        .hp-text {
            position: absolute;
            width: 100%;
            text-align: center;
            top: 0;
            line-height: 16px;
            font-size: 10px;
            font-weight: 700;
            color: white;
        }

        .monster-name-display {
            font-size: 15px;
            font-weight: 600;
            color: #ccc;
            margin-bottom: 5px;
            text-shadow: 0 2px 4px black;
        }

        .monster-sprite {
            font-size: 120px;
            transition: transform 0.08s;
            filter: drop-shadow(0 0 30px rgba(0,0,0,0.3));
        }
        .monster-sprite:active { transform: scale(0.9); }
        .monster-sprite.hit { animation: shake 0.2s; }
        .monster-sprite.dead { animation: die 0.3s forwards; }

        .is-boss .monster-sprite { font-size: 160px; filter: drop-shadow(0 0 50px rgba(255, 69, 58, 0.5)); }
        .is-boss .hp-bar-container { border-color: var(--hp-color); box-shadow: 0 0 10px rgba(255, 69, 58, 0.3); }
        .is-boss .monster-name-display { color: var(--hp-color); font-size: 18px; text-transform: uppercase; }

        /* --- CONTROLS --- */
        .controls {
            background: var(--card-bg);
            border-top-left-radius: 24px;
            border-top-right-radius: 24px;
            height: 48vh;
            display: flex;
            flex-direction: column;
            box-shadow: 0 -10px 40px rgba(0,0,0,0.5);
            overflow: hidden;
            position: relative;
            z-index: 20;
        }

        .tabs {
            display: flex;
            background: rgba(0,0,0,0.3);
            flex-shrink: 0;
            padding: 5px 5px 0 5px;
            overflow-x: auto;
        }
        .tabs::-webkit-scrollbar { display: none; }

        .tab-btn {
            flex: 1;
            padding: 12px;
            min-width: 80px;
            background: none;
            border: none;
            color: #636366;
            font-weight: 700;
            font-size: 12px;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            white-space: nowrap;
        }
        .tab-btn.active {
            color: white;
            border-bottom: 2px solid var(--accent);
            background: linear-gradient(to top, var(--tab-active-bg), transparent);
        }

        .tab-content {
            padding: 15px;
            overflow-y: auto;
            flex-grow: 1;
            display: none;
            padding-bottom: 80px;
        }
        .tab-content.active { display: block; }

        .upgrade-card {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(255,255,255,0.06);
            padding: 10px;
            border-radius: 14px;
            margin-bottom: 8px;
        }

        .upgrade-info { flex-grow: 1; margin-right: 10px; }
        .upgrade-info h4 { margin: 0; font-size: 14px; color: white; }
        .upgrade-info p { margin: 3px 0 0; font-size: 11px; color: var(--text-secondary); }

        .buy-btn {
            background: #30d158;
            color: #000;
            border: none;
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 800;
            min-width: 70px;
            text-align: center;
        }
        .buy-btn:disabled { background: #3a3a3c; color: #8e8e93; opacity: 1; }

        .buy-btn.essence {
            background: var(--essence-color);
            color: white;
        }

        /* ANIMATIONS */
        .damage-text {
            position: absolute;
            color: white;
            font-weight: 900;
            font-size: 24px;
            pointer-events: none;
            animation: floatUp 0.7s forwards;
            text-shadow: 0 2px 4px rgba(0,0,0,0.5);
            z-index: 100;
        }
        .crit { color: #ff453a; font-size: 32px; z-index: 101; }
        .reward-text {
            color: #ffd60a;
            font-size: 24px;
            z-index: 102;
            text-shadow: 0 2px 8px rgba(0,0,0,0.8);
            width: 100%;
            text-align: center;
            left: 0 !important;
        }
        .essence-text { color: var(--essence-color); font-size: 28px; z-index: 103; }

        @keyframes floatUp {
            0% { transform: translateY(0) scale(1); opacity: 1; }
            50% { opacity: 1; }
            100% { transform: translateY(-80px) scale(1.2); opacity: 0; }
        }
        @keyframes shake {
            0% { transform: rotate(0); }
            25% { transform: rotate(-5deg); }
            75% { transform: rotate(5px); }
            100% { transform: rotate(0); }
        }
        @keyframes die {
            0% { transform: scale(1); opacity: 1; }
            100% { transform: scale(0); opacity: 0; }
        }
    </style>
</head>
<body>

    <div class="hero-panel">
        <div class="hero-stats-left">
            <div class="hero-lvl" id="heroLvlText">LVL 1</div>

            <div class="damage-display">
                <div class="dmg-row click-dmg">
                    <span>‚öîÔ∏è</span> <span id="clickDmgText">0</span>
                </div>
                <div class="dmg-row idle-dps">
                    <span>‚ö°</span> <span id="idleDpsText">0</span> / —Å–µ–∫
                </div>
            </div>
        </div>

        <div class="hero-stats-right">
            <div class="currency-row gold-val"><span id="gold">0</span> üí∞</div>
            <div class="currency-row essence-val"><span id="essence">0</span> üíé</div>
        </div>
        <div class="xp-container"><div class="xp-bar" id="xpBar"></div></div>
    </div>

    <div id="saveStatus">‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ</div>

    <div class="arena" id="arena">
        <div class="stage-nav">
            <button class="nav-btn" id="prevStageBtn" onclick="changeStage(-1)">‚ùÆ</button>
            <div class="stage-info">
                <div class="stage-title">–£–†–û–í–ï–ù–¨</div>
                <div class="stage-number" id="stageNum">1</div>
            </div>
            <button class="nav-btn" id="nextStageBtn" onclick="changeStage(1)">‚ùØ</button>
        </div>

        <div class="monster-counter" id="monsterCounter">1 / 10</div>

        <div class="monster-container">
            <div class="monster-name-display" id="monsterNameDisplay">...</div>

            <div class="hp-bar-container">
                <div class="hp-bar" id="hpBar"></div>
                <div class="hp-text" id="hpText">Loading...</div>
            </div>

            <div class="monster-sprite" id="monster" onpointerdown="attack(event)">üëæ</div>
        </div>
    </div>

    <div class="controls">
        <div class="tabs">
            <button class="tab-btn active" onclick="openTab('hero')">–ì–µ—Ä–æ–π</button>
            <button class="tab-btn" onclick="openTab('allies')">–ê—Ä–º–∏—è</button>
            <button class="tab-btn" onclick="openTab('workshop')">–ú–∞—Å—Ç–µ—Ä—Å–∫–∞—è</button>
            <button class="tab-btn" style="color:var(--essence-color)" onclick="openTab('relics')">–†–µ–ª–∏–∫–≤–∏–∏</button>
        </div>

        <div id="tab-hero" class="tab-content active">
            <div class="upgrade-card">
                <div class="upgrade-info">
                    <h4>‚öîÔ∏è –ê—Ç–∞–∫–∞</h4>
                    <p>–£—Ä–æ–Ω: <span id="dmgVal">1</span></p>
                </div>
                <button class="buy-btn" id="btnBuyDmg" onclick="upgrade('damage')">10</button>
            </div>

            <div class="upgrade-card">
                <div class="upgrade-info">
                    <h4>üéØ –ú–µ—Ç–∫–æ—Å—Ç—å</h4>
                    <p>–®–∞–Ω—Å –∫—Ä–∏—Ç–∞: <span id="critVal">0</span>%</p>
                </div>
                <button class="buy-btn" id="btnBuyCrit" onclick="upgrade('crit')">50</button>
            </div>

            <div class="upgrade-card">
                <div class="upgrade-info">
                    <h4>ü©∏ –ñ–µ—Å—Ç–æ–∫–æ—Å—Ç—å</h4>
                    <p>–ö—Ä–∏—Ç. —É—Ä–æ–Ω: x<span id="critMultiVal">2.0</span></p>
                </div>
                <button class="buy-btn" id="btnBuyFerocity" onclick="upgrade('ferocity')">200</button>
            </div>

            <div class="upgrade-card">
                <div class="upgrade-info">
                    <h4>üí∞ –ê–ª—á–Ω–æ—Å—Ç—å</h4>
                    <p>–ó–æ–ª–æ—Ç–æ: +<span id="greedVal">0</span>%</p>
                </div>
                <button class="buy-btn" id="btnBuyGreed" onclick="upgrade('greed')">500</button>
            </div>
        </div>

        <div id="tab-allies" class="tab-content">
            <div class="upgrade-card">
                <div class="upgrade-info">
                    <h4>üèπ –õ—É—á–Ω–∏–∫</h4>
                    <p>DPS: <span id="dpsArcher">5</span> | –£—Ä. <span id="allyArcherLvl">0</span></p>
                </div>
                <button class="buy-btn" id="btnBuyArcher" onclick="upgradeAlly('archer')">100</button>
            </div>

            <div class="upgrade-card">
                <div class="upgrade-info">
                    <h4>üßô –ú–∞–≥ –û–≥–Ω—è</h4>
                    <p>DPS: <span id="dpsMage">25</span> | –£—Ä. <span id="allyMageLvl">0</span></p>
                </div>
                <button class="buy-btn" id="btnBuyMage" onclick="upgradeAlly('mage')">600</button>
            </div>

            <div class="upgrade-card">
                <div class="upgrade-info">
                    <h4>üõ° –†—ã—Ü–∞—Ä—å</h4>
                    <p>DPS: <span id="dpsKnight">100</span> | –£—Ä. <span id="allyKnightLvl">0</span></p>
                </div>
                <button class="buy-btn" id="btnBuyKnight" onclick="upgradeAlly('knight')">3K</button>
            </div>

            <div class="upgrade-card">
                <div class="upgrade-info">
                    <h4>üíÄ –ù–µ–∫—Ä–æ–º–∞–Ω—Ç</h4>
                    <p>DPS: <span id="dpsWarlock">500</span> | –£—Ä. <span id="allyWarlockLvl">0</span></p>
                </div>
                <button class="buy-btn" id="btnBuyWarlock" onclick="upgradeAlly('warlock')">20K</button>
            </div>

            <div class="upgrade-card">
                <div class="upgrade-info">
                    <h4>üóø –¢–∏—Ç–∞–Ω</h4>
                    <p>DPS: <span id="dpsTitan">2.5k</span> | –£—Ä. <span id="allyTitanLvl">0</span></p>
                </div>
                <button class="buy-btn" id="btnBuyTitan" onclick="upgradeAlly('titan')">150K</button>
            </div>

            <div class="upgrade-card">
                <div class="upgrade-info">
                    <h4>üëº –ê–Ω–≥–µ–ª</h4>
                    <p>DPS: <span id="dpsAngel">10k</span> | –£—Ä. <span id="allyAngelLvl">0</span></p>
                </div>
                <button class="buy-btn" id="btnBuyAngel" onclick="upgradeAlly('angel')">1M</button>
            </div>

             <div class="upgrade-card">
                <div class="upgrade-info">
                    <h4>‚ö° –ó–µ–≤—Å</h4>
                    <p>DPS: <span id="dpsZeus">50k</span> | –£—Ä. <span id="allyZeusLvl">0</span></p>
                </div>
                <button class="buy-btn" id="btnBuyZeus" onclick="upgradeAlly('zeus')">50M</button>
            </div>
        </div>

        <div id="tab-workshop" class="tab-content">
            <div class="upgrade-card">
                <div class="upgrade-info">
                    <h4>üèπ –¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ –õ—É—á–Ω–∏–∫–æ–≤</h4>
                    <p>+20% —É—Ä–æ–Ω–∞ –ª—É—á–Ω–∏–∫–æ–≤</p>
                    <p style="color:var(--accent)">–ë–æ–Ω—É—Å: +<span id="techArcherVal">0</span>%</p>
                </div>
                <button class="buy-btn" id="btnTechArcher" onclick="upgradeTech('archerBoost')">1K</button>
            </div>

            <div class="upgrade-card">
                <div class="upgrade-info">
                    <h4>üßô –ú–∞–≥–∏—á–µ—Å–∫–∏–π –ö—Ä—É–≥</h4>
                    <p>+20% —É—Ä–æ–Ω–∞ –º–∞–≥–æ–≤</p>
                    <p style="color:var(--accent)">–ë–æ–Ω—É—Å: +<span id="techMageVal">0</span>%</p>
                </div>
                <button class="buy-btn" id="btnTechMage" onclick="upgradeTech('mageBoost')">5K</button>
            </div>

            <div class="upgrade-card">
                <div class="upgrade-info">
                    <h4>üê≤ –£–±–∏–π—Ü–∞ –ë–æ—Å—Å–æ–≤</h4>
                    <p>+10% —É—Ä–æ–Ω–∞ –ø–æ –ë–æ—Å—Å–∞–º (–ì–µ—Ä–æ–π)</p>
                    <p style="color:var(--accent)">–ë–æ–Ω—É—Å: +<span id="techBossVal">0</span>%</p>
                </div>
                <button class="buy-btn" id="btnTechBoss" onclick="upgradeTech('bossSlayer')">10K</button>
            </div>
        </div>

        <div id="tab-relics" class="tab-content">
            <div style="padding:10px; text-align:center; color:var(--essence-color); font-size:12px;">
                –≠—Å—Å–µ–Ω—Ü–∏—è –ø–∞–¥–∞–µ—Ç —Ç–æ–ª—å–∫–æ —Å –ë–æ—Å—Å–æ–≤!
            </div>

            <div class="upgrade-card" style="border:1px solid var(--essence-color)">
                <div class="upgrade-info">
                    <h4>‚öîÔ∏è –ú–µ—á –¢–∏—Ç–∞–Ω–∞</h4>
                    <p>–£–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç –í–ï–°–¨ —É—Ä–æ–Ω</p>
                    <p style="color:var(--essence-color)">–ë–æ–Ω—É—Å: x<span id="relicDmgVal">1.0</span></p>
                </div>
                <button class="buy-btn essence" id="btnRelicDmg" onclick="upgradeRelic('titanSword')">1 üíé</button>
            </div>

            <div class="upgrade-card" style="border:1px solid var(--essence-color)">
                <div class="upgrade-info">
                    <h4>üí∞ –†–æ–≥ –ò–∑–æ–±–∏–ª–∏—è</h4>
                    <p>–£–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç –í–°–Å –∑–æ–ª–æ—Ç–æ</p>
                    <p style="color:var(--essence-color)">–ë–æ–Ω—É—Å: x<span id="relicGoldVal">1.0</span></p>
                </div>
                <button class="buy-btn essence" id="btnRelicGold" onclick="upgradeRelic('goldHorn')">1 üíé</button>
            </div>

            <div class="upgrade-card" style="border:1px solid var(--essence-color)">
                <div class="upgrade-info">
                    <h4>üßø –û–∫–æ –ë–µ–∑–¥–Ω—ã</h4>
                    <p>–®–∞–Ω—Å –Ω–∞–Ω–µ—Å—Ç–∏ x10 —É—Ä–æ–Ω</p>
                    <p style="color:var(--essence-color)">–®–∞–Ω—Å: <span id="relicFatalVal">0</span>%</p>
                </div>
                <button class="buy-btn essence" id="btnRelicFatal" onclick="upgradeRelic('fatalStrike')">5 üíé</button>
            </div>
        </div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();

        // === –î–ê–ù–ù–´–ï –ò–ì–†–´ ===
        const initialState = {
            gold: 0,
            essence: 0,
            level: 1,
            xp: 0,
            xpToNext: 100,

            stage: 1,
            maxStage: 1,
            killsInStage: 0,

            stats: {
                damage: 1,
                critChance: 0,
                critMulti: 2.0,
                goldBonus: 0
            },

            allies: {
                archer: { lvl: 0, dpsBase: 5, cost: 100 },
                mage: { lvl: 0, dpsBase: 25, cost: 600 },
                knight: { lvl: 0, dpsBase: 100, cost: 3000 },
                warlock: { lvl: 0, dpsBase: 500, cost: 20000 },
                titan: { lvl: 0, dpsBase: 2500, cost: 150000 },
                angel: { lvl: 0, dpsBase: 10000, cost: 1000000 },
                zeus: { lvl: 0, dpsBase: 50000, cost: 50000000 }
            },

            workshop: {
                archerBoost: { level: 0, multi: 0.2, cost: 1000 },
                mageBoost: { level: 0, multi: 0.2, cost: 5000 },
                bossSlayer: { level: 0, multi: 0.1, cost: 10000 }
            },

            relics: {
                titanSword: { level: 0, multi: 0.1, cost: 1 },
                goldHorn: { level: 0, multi: 0.1, cost: 1 },
                fatalStrike: { level: 0, chance: 1, cost: 5 }
            },

            costs: {
                damage: 10,
                crit: 50,
                ferocity: 200,
                greed: 500
            },

            monster: { hp: 20, maxHp: 20, type: 0, prefix: 0, isBoss: false }
        };

        let game = JSON.parse(JSON.stringify(initialState));
        let isCloudLoading = true;

        const monsters = ["–°–ª–∞–π–º", "–ì–æ–±–ª–∏–Ω", "–°–∫–µ–ª–µ—Ç", "–ü—Ä–∏–∑—Ä–∞–∫", "–û—Ä–∫", "–í–æ–ª–∫", "–í–∞–º–ø–∏—Ä", "–ó–æ–º–±–∏"];
        const bosses = ["–î—Ä–∞–∫–æ–Ω", "–ö—Ä–∞–∫–µ–Ω", "–î–µ–º–æ–Ω", "–ì–∏–≥–∞–Ω—Ç", "–õ–∏—á", "–¢–∏—Ç–∞–Ω"];
        const prefixes = ["", "–ó–ª–æ–π ", "–î–∏–∫–∏–π ", "–î—Ä–µ–≤–Ω–∏–π ", "–¢–µ–º–Ω—ã–π ", "–õ–µ–¥—è–Ω–æ–π ", "–û–≥–Ω–µ–Ω–Ω—ã–π ", "–¢–æ–∫—Å–∏—á–Ω—ã–π "];
        const monsterEmojis = ["üëæ", "üë∫", "üíÄ", "üëª", "üëπ", "üê∫", "üßõ", "üßü"];
        const bossEmojis = ["üê≤", "üêô", "üëø", "üóø", "üßô‚Äç‚ôÇÔ∏è", "ü¶ç"];

        // === –°–û–•–†–ê–ù–ï–ù–ò–Ø ===
        function initGame() {
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º –Ω–æ–≤—ã–π –∫–ª—é—á –¥–ª—è –≤–µ—Ä—Å–∏–π 7.2, –Ω–æ –ø–æ–¥–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ 7.1
            tg.CloudStorage.getItem('rpg_save_v7_2_final', (err, value) => {
                if (!err && value) {
                    try {
                        const parsed = JSON.parse(value);
                        mergeData(game, parsed);
                    } catch (e) { console.error(e); }
                } else {
                    const oldSave = localStorage.getItem('rpg_save_v7_1_army') || localStorage.getItem('rpg_save_v7_relics');
                    if (oldSave) {
                        try {
                            const parsedOld = JSON.parse(oldSave);
                            mergeData(game, parsedOld);
                        } catch(e) {}
                    }
                }
                isCloudLoading = false;
                renderUI();
                spawnMonster(false);
            });
        }

        function mergeData(target, source) {
            for (const key in source) {
                if (source[key] instanceof Object && key in target) {
                    Object.assign(source[key], mergeData(target[key], source[key]));
                }
            }
            Object.assign(target || {}, source);
            return target;
        }

        function saveGame() {
            if (isCloudLoading) return;
            const dataStr = JSON.stringify(game);
            localStorage.setItem('rpg_save_v7_2_final', dataStr);
            tg.CloudStorage.setItem('rpg_save_v7_2_final', dataStr, (err, stored) => {
                if (!err && stored) showSaveStatus();
            });
        }

        function showSaveStatus() {
            const el = document.getElementById('saveStatus');
            el.style.opacity = 1;
            setTimeout(() => el.style.opacity = 0, 2000);
        }

        setInterval(saveGame, 60000); // –ê–≤—Ç–æ—Å–µ–π–≤ —Ä–∞–∑ –≤ –º–∏–Ω—É—Ç—É

        // === –†–ê–°–ß–ï–¢–´ –ë–û–ù–£–°–û–í ===

        function getGlobalDamageMulti() {
            return 1 + (game.relics.titanSword.level * game.relics.titanSword.multi);
        }

        function getGlobalGoldMulti() {
            return 1 + (game.relics.goldHorn.level * game.relics.goldHorn.multi);
        }

        function getAllyDps(type) {
            const ally = game.allies[type];
            let dps = ally.lvl * ally.dpsBase;

            if (type === 'archer') dps *= (1 + (game.workshop.archerBoost.level * game.workshop.archerBoost.multi));
            if (type === 'mage') dps *= (1 + (game.workshop.mageBoost.level * game.workshop.mageBoost.multi));

            dps *= getGlobalDamageMulti();
            return dps;
        }

        function calculateTotalDps() {
            let total = 0;
            for (let key in game.allies) {
                total += getAllyDps(key);
            }
            return total;
        }

        function getHeroClickDamage() {
            let dmg = game.stats.damage;
            if (game.monster.isBoss) {
                dmg *= (1 + (game.workshop.bossSlayer.level * game.workshop.bossSlayer.multi));
            }
            dmg *= getGlobalDamageMulti();
            return dmg;
        }

        // === –ò–ì–†–û–í–û–ô –¶–ò–ö–õ ===
        setInterval(() => {
            if (isCloudLoading) return;
            const dps = calculateTotalDps();
            if (dps > 0 && game.monster.hp > 0) {
                dealDamage(dps / 10, false, false);
            }
        }, 100);

        function attack(e) {
            if (isCloudLoading || game.monster.hp <= 0) return;

            let damage = getHeroClickDamage();
            let isCrit = Math.random() * 100 < game.stats.critChance;
            let isFatal = false;

            if (!isCrit) {
                 if (Math.random() * 100 < (game.relics.fatalStrike.level * game.relics.fatalStrike.chance)) {
                     damage *= 10;
                     isFatal = true;
                 }
            }

            if (isCrit) damage = Math.floor(damage * game.stats.critMulti);

            const rect = e.target.getBoundingClientRect();
            const x = e.clientX || (rect.left + rect.width/2);
            const y = e.clientY || (rect.top + rect.height/2);

            if (isFatal) tg.HapticFeedback.notificationOccurred('warning');
            else tg.HapticFeedback.impactOccurred(isCrit ? 'medium' : 'light');

            dealDamage(damage, true, isCrit, x, y, isFatal);
        }

        function dealDamage(amount, isClick, isCrit, x, y, isFatal) {
            game.monster.hp -= amount;

            if (isClick) {
                let type = 'damage';
                if (isCrit) type = 'crit';
                if (isFatal) type = 'essence-text';

                let text = formatNumber(Math.floor(amount)); // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º —á–∏—Å–ª–æ —É—Ä–æ–Ω–∞ (k, M)
                if (isFatal) text = "‚ò†Ô∏è " + text;

                showFloatingText(x, y, text, type);
                animateMonsterHit();
            }

            if (game.monster.hp <= 0) {
                game.monster.hp = 0;
                killMonster();
            }
            renderUI();
        }

        function killMonster() {
            tg.HapticFeedback.notificationOccurred('success');

            let baseGold = 5 * Math.pow(1.55, game.stage - 1);
            if (game.monster.isBoss) baseGold *= 10;

            let bonusMulti = (1 + (game.stats.goldBonus / 100)) * getGlobalGoldMulti();
            let finalGold = Math.floor(baseGold * bonusMulti);
            game.gold += finalGold;

            let essenceDrop = 0;
            if (game.monster.isBoss) {
                essenceDrop = 1;
                if (game.stage % 10 === 0) essenceDrop += 1;
                game.essence += essenceDrop;
            }

            let xpReward = 15 + (game.stage * 3);
            gainXp(xpReward);

            showFloatingText(window.innerWidth / 2, window.innerHeight / 2 - 100, `+${formatNumber(finalGold)}üí∞`, 'reward');
            if (essenceDrop > 0) {
                 setTimeout(() => {
                    showFloatingText(window.innerWidth / 2, window.innerHeight / 2 - 140, `+${essenceDrop}üíé`, 'essence-text');
                 }, 200);
            }

            const m = document.getElementById('monster');
            m.classList.add('dead');

            setTimeout(() => {
                m.classList.remove('dead');

                if (game.monster.isBoss) {
                    if (game.stage === game.maxStage) game.maxStage++;
                    game.stage++;
                    game.killsInStage = 0;

                    // –°–û–•–†–ê–ù–ï–ù–ò–ï –ü–û–°–õ–ï –ë–û–°–°–ê (–°—Ç–∞–¥–∏—è —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è!)
                    saveGame();
                } else {
                    game.killsInStage++;
                }
                spawnMonster(true);
            }, 350);
        }

        function spawnMonster(forceNew) {
            if (game.monster.hp > 0 && !forceNew) return;

            const isBossSpawn = (game.killsInStage >= 9);
            game.monster.isBoss = isBossSpawn;

            let hpBase = 25 * Math.pow(1.55, game.stage - 1);

            if (isBossSpawn) {
                hpBase *= 12;
                game.monster.type = Math.floor(Math.random() * bosses.length);
                game.monster.prefix = 0;
            } else {
                game.monster.type = Math.floor(Math.random() * monsters.length);
                if (Math.random() > 0.7) {
                    game.monster.prefix = Math.floor(Math.random() * (prefixes.length - 1)) + 1;
                    hpBase *= 1.5;
                } else {
                    game.monster.prefix = 0;
                }
            }

            game.monster.maxHp = Math.floor(hpBase);
            game.monster.hp = game.monster.maxHp;

            renderUI();
        }

        function gainXp(amount) {
            game.xp += amount;
            if (game.xp >= game.xpToNext) {
                game.level++;
                game.xp -= game.xpToNext;
                game.xpToNext = Math.floor(game.xpToNext * 1.5);
                tg.HapticFeedback.notificationOccurred('success');
            }
        }

        function changeStage(delta) {
            const newStage = game.stage + delta;
            if (newStage >= 1 && newStage <= game.maxStage) {
                game.stage = newStage;
                game.killsInStage = 0;
                spawnMonster(true);
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø—Ä–∏ —Å–º–µ–Ω–µ —Å—Ç–∞–¥–∏–∏, —á—Ç–æ–±—ã –Ω–µ –ø–æ—Ç–µ—Ä—è—Ç—å –ø–æ–∑–∏—Ü–∏—é
                saveGame();
                renderUI();
            }
        }

        // === UPGRADES ===
        function openTab(tabName) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.getElementById('tab-' + tabName).classList.add('active');
            tg.HapticFeedback.selectionChanged();
        }

        function upgrade(type) {
            const cost = game.costs[type];
            if (game.gold >= cost) {
                game.gold -= cost;

                if (type === 'damage') {
                    game.stats.damage += Math.ceil(game.stats.damage * 0.5);
                    game.costs.damage = Math.floor(game.costs.damage * 1.6);
                } else if (type === 'crit') {
                    game.stats.critChance = Math.min(game.stats.critChance + 1, 80);
                    game.costs.crit = Math.floor(game.costs.crit * 1.5);
                } else if (type === 'ferocity') {
                    game.stats.critMulti = parseFloat((game.stats.critMulti + 0.1).toFixed(1));
                    game.costs.ferocity = Math.floor(game.costs.ferocity * 1.8);
                } else if (type === 'greed') {
                    game.stats.goldBonus += 10;
                    game.costs.greed = Math.floor(game.costs.greed * 1.8);
                }
                saveAndRender();
            }
        }

        function upgradeAlly(type) {
            const ally = game.allies[type];
            if (game.gold >= ally.cost) {
                game.gold -= ally.cost;
                ally.lvl += 1;
                ally.cost = Math.floor(ally.cost * 1.4);
                saveAndRender();
            }
        }

        function upgradeTech(type) {
            const tech = game.workshop[type];
            if (game.gold >= tech.cost) {
                game.gold -= tech.cost;
                tech.level += 1;
                tech.cost = Math.floor(tech.cost * 2.5);
                saveAndRender();
            }
        }

        function upgradeRelic(type) {
            const relic = game.relics[type];
            if (game.essence >= relic.cost) {
                game.essence -= relic.cost;
                relic.level += 1;
                relic.cost += 1;
                tg.HapticFeedback.notificationOccurred('success');
                saveAndRender();
            }
        }

        function saveAndRender() {
            tg.HapticFeedback.selectionChanged();
            renderUI();
            saveGame();
        }

        // === RENDER ===
        function showFloatingText(x, y, text, type) {
            const el = document.createElement('div');
            el.className = `damage-text ${type === 'crit' ? 'crit' : ''} ${type === 'reward' ? 'reward-text' : ''} ${type === 'essence-text' ? 'essence-text' : ''}`;
            el.innerText = text;
            if (type !== 'reward' && type !== 'essence-text') {
                const rndX = (Math.random() - 0.5) * 80;
                el.style.left = (x + rndX) + 'px';
                el.style.top = y + 'px';
            } else {
                el.style.top = y + 'px';
            }
            document.body.appendChild(el);
            setTimeout(() => el.remove(), 700);
        }

        function animateMonsterHit() {
            const m = document.getElementById('monster');
            m.classList.remove('hit');
            void m.offsetWidth;
            m.classList.add('hit');
        }

        function formatNumber(num) {
            if (num >= 1e9) return (num / 1e9).toFixed(2) + 'B';
            if (num >= 1e6) return (num / 1e6).toFixed(2) + 'M';
            if (num >= 1e3) return (num / 1e3).toFixed(1) + 'k';
            return Math.floor(num);
        }

        function renderUI() {
            document.getElementById('gold').innerText = formatNumber(game.gold);
            document.getElementById('essence').innerText = formatNumber(game.essence);
            document.getElementById('heroLvlText').innerText = `LVL ${game.level}`;

            // –ù–æ–≤–æ–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —É—Ä–æ–Ω–∞
            document.getElementById('clickDmgText').innerText = formatNumber(getHeroClickDamage());
            document.getElementById('idleDpsText').innerText = formatNumber(calculateTotalDps());

            const xpPct = Math.min(100, (game.xp / game.xpToNext) * 100);
            document.getElementById('xpBar').style.width = `${xpPct}%`;

            document.getElementById('stageNum').innerText = game.stage;
            document.getElementById('prevStageBtn').disabled = (game.stage <= 1);
            document.getElementById('nextStageBtn').disabled = (game.stage >= game.maxStage);

            const arena = document.getElementById('arena');
            const nameEl = document.getElementById('monsterNameDisplay');
            const spriteEl = document.getElementById('monster');

            if (game.monster.isBoss) {
                document.getElementById('monsterCounter').innerText = "üíÄ –ë–ò–¢–í–ê –° –ë–û–°–°–û–ú";
                document.getElementById('monsterCounter').style.color = "#ff453a";
                nameEl.innerText = bosses[game.monster.type % bosses.length];
                spriteEl.innerText = bossEmojis[game.monster.type % bossEmojis.length];
                arena.classList.add('is-boss');
            } else {
                document.getElementById('monsterCounter').innerText = `${game.killsInStage + 1} / 10`;
                document.getElementById('monsterCounter').style.color = "#8e8e93";
                const prefixStr = prefixes[game.monster.prefix];
                nameEl.innerText = prefixStr + monsters[game.monster.type];
                spriteEl.innerText = monsterEmojis[game.monster.type];
                arena.classList.remove('is-boss');
            }

            const hpPct = Math.max(0, (game.monster.hp / game.monster.maxHp) * 100);
            document.getElementById('hpBar').style.width = `${hpPct}%`;
            document.getElementById('hpText').innerText = `${formatNumber(game.monster.hp)} / ${formatNumber(game.monster.maxHp)}`;

            // Buttons
            updateBtn('btnBuyDmg', game.costs.damage, game.gold);
            updateBtn('btnBuyCrit', game.costs.crit, game.gold);
            updateBtn('btnBuyFerocity', game.costs.ferocity, game.gold);
            updateBtn('btnBuyGreed', game.costs.greed, game.gold);

            updateBtn('btnBuyArcher', game.allies.archer.cost, game.gold);
            updateBtn('btnBuyMage', game.allies.mage.cost, game.gold);
            updateBtn('btnBuyKnight', game.allies.knight.cost, game.gold);
            updateBtn('btnBuyWarlock', game.allies.warlock.cost, game.gold);
            updateBtn('btnBuyTitan', game.allies.titan.cost, game.gold);
            updateBtn('btnBuyAngel', game.allies.angel.cost, game.gold);
            updateBtn('btnBuyZeus', game.allies.zeus.cost, game.gold);

            updateBtn('btnTechArcher', game.workshop.archerBoost.cost, game.gold);
            updateBtn('btnTechMage', game.workshop.mageBoost.cost, game.gold);
            updateBtn('btnTechBoss', game.workshop.bossSlayer.cost, game.gold);

            updateBtn('btnRelicDmg', game.relics.titanSword.cost, game.essence);
            updateBtn('btnRelicGold', game.relics.goldHorn.cost, game.essence);
            updateBtn('btnRelicFatal', game.relics.fatalStrike.cost, game.essence);

            // Text Values
            document.getElementById('dmgVal').innerText = formatNumber(game.stats.damage);
            document.getElementById('critVal').innerText = game.stats.critChance;
            document.getElementById('critMultiVal').innerText = game.stats.critMulti.toFixed(1);
            document.getElementById('greedVal').innerText = game.stats.goldBonus;

            // Allies Texts
            document.getElementById('dpsArcher').innerText = formatNumber(getAllyDps('archer'));
            document.getElementById('allyArcherLvl').innerText = game.allies.archer.lvl;
            document.getElementById('dpsMage').innerText = formatNumber(getAllyDps('mage'));
            document.getElementById('allyMageLvl').innerText = game.allies.mage.lvl;
            document.getElementById('dpsKnight').innerText = formatNumber(getAllyDps('knight'));
            document.getElementById('allyKnightLvl').innerText = game.allies.knight.lvl;
            document.getElementById('dpsWarlock').innerText = formatNumber(getAllyDps('warlock'));
            document.getElementById('allyWarlockLvl').innerText = game.allies.warlock.lvl;
            document.getElementById('dpsTitan').innerText = formatNumber(getAllyDps('titan'));
            document.getElementById('allyTitanLvl').innerText = game.allies.titan.lvl;
            document.getElementById('dpsAngel').innerText = formatNumber(getAllyDps('angel'));
            document.getElementById('allyAngelLvl').innerText = game.allies.angel.lvl;
            document.getElementById('dpsZeus').innerText = formatNumber(getAllyDps('zeus'));
            document.getElementById('allyZeusLvl').innerText = game.allies.zeus.lvl;

            document.getElementById('techArcherVal').innerText = Math.round(game.workshop.archerBoost.level * game.workshop.archerBoost.multi * 100);
            document.getElementById('techMageVal').innerText = Math.round(game.workshop.mageBoost.level * game.workshop.mageBoost.multi * 100);
            document.getElementById('techBossVal').innerText = Math.round(game.workshop.bossSlayer.level * game.workshop.bossSlayer.multi * 100);

            document.getElementById('relicDmgVal').innerText = getGlobalDamageMulti().toFixed(1);
            document.getElementById('relicGoldVal').innerText = getGlobalGoldMulti().toFixed(1);
            document.getElementById('relicFatalVal').innerText = (game.relics.fatalStrike.level * game.relics.fatalStrike.chance);
        }

        function updateBtn(id, cost, balance) {
            const btn = document.getElementById(id);
            if (!btn) return;
            btn.innerText = `${formatNumber(cost)}`;
            if (id.includes('Relic')) btn.innerText += " üíé";
            btn.disabled = balance < cost;
        }

        initGame();

    </script>
</body>
</html>